<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZeroLog</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Failed', err));
        });
    }
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9180492943097575" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<style>
    :root { 
        --bg: #000; 
        --card: #0a0a0a; 
        --accent: #2563eb; 
        --success: #16a34a; 
        --text: #fff; 
        --dim: #888; 
        --danger: #b91c1c; 
        --warning: #f59e0b; 
    }
    
    [data-theme="light"] {
        --bg: #ffffff;
        --card: #f5f5f5;
        --accent: #2563eb;
        --success: #16a34a;
        --text: #000;
        --dim: #666;
        --danger: #dc2626;
        --warning: #f59e0b;
    }
    
    * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
    body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 100px; transition: background 0.3s, color 0.3s; }
    h1 { font-style: italic; font-weight: 900; letter-spacing: -1px; margin: 0; text-transform: uppercase; }

    .workout-timer { 
        position: fixed; 
        top: 10px; 
        right: 10px; 
        background: rgba(37, 99, 235, 0.2); 
        padding: 8px 16px; 
        border-radius: 20px; 
        font-size: 14px; 
        font-weight: bold; 
        color: var(--accent); 
        border: 1px solid var(--accent);
        z-index: 100;
        display: none;
    }
    .workout-timer.active { display: block; }

    /* Quick Timer Bar */
    .quick-timer-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--card);
        border-top: 1px solid #222;
        padding: 10px;
        display: none;
        gap: 8px;
        z-index: 99;
        overflow-x: auto;
    }
    .quick-timer-bar.active { display: flex; }
    .quick-timer-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        white-space: nowrap;
        font-size: 14px;
    }

    /* Workout Stats Dashboard */
    .workout-stats-quick {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }
    .stat-quick {
        background: var(--card);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #222;
    }
    .stat-quick-value {
        font-size: 20px;
        font-weight: bold;
        color: var(--accent);
    }
    .stat-quick-label {
        font-size: 10px;
        color: var(--dim);
        text-transform: uppercase;
        margin-top: 4px;
    }

    /* Recent Exercises */
    .recent-exercises {
        margin-bottom: 15px;
    }
    .recent-exercises-title {
        font-size: 11px;
        color: var(--dim);
        text-transform: uppercase;
        font-weight: bold;
        margin-bottom: 8px;
    }
    .recent-ex-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    .recent-ex-btn {
        background: #1a1a1a;
        border: 1px solid #333;
        color: var(--text);
        padding: 10px;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
        text-align: left;
    }
    .recent-ex-btn-name {
        font-weight: bold;
        margin-bottom: 3px;
    }
    .recent-ex-btn-meta {
        font-size: 9px;
        color: var(--dim);
    }

    /* PR Display */
    .pr-display {
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid #fbbf24;
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 10px;
        font-size: 11px;
    }
    .pr-display-label {
        color: #fbbf24;
        font-weight: bold;
        margin-bottom: 3px;
    }
    .pr-display-value {
        color: var(--text);
    }

    /* Muscle Group Volume */
    .muscle-volume-card {
        background: var(--card);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #222;
    }
    .muscle-volume-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #222;
    }
    .muscle-volume-item:last-child {
        border-bottom: none;
    }
    .muscle-volume-bar {
        height: 6px;
        background: #222;
        border-radius: 3px;
        margin-top: 5px;
        overflow: hidden;
    }
    .muscle-volume-fill {
        height: 100%;
        background: var(--accent);
        transition: width 0.3s;
    }

    /* Template Buttons */
    .template-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        overflow-x: auto;
    }
    .template-btn {
        background: #222;
        border: 1px solid #333;
        color: var(--text);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        cursor: pointer;
    }
    .template-btn.active { background: var(--accent); color: white; }

    /* Workout Notes */
    .workout-notes-section {
        background: var(--card);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid #222;
    }
    .workout-notes-section textarea {
        width: 100%;
        background: #111;
        border: 1px solid #222;
        color: var(--text);
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
    }

    /* Set Type Extended */
    .set-type-badge {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: bold;
        margin-left: 5px;
    }
    .warmup-badge { background: #f59e0b; color: #000; }
    .cluster-badge { background: #8b5cf6; color: #fff; }
    .drop-badge { background: #ec4899; color: #fff; }
    .amrap-badge { background: #10b981; color: #fff; }

    /* Theme Toggle */
    .theme-toggle {
        position: fixed;
        top: 10px;
        left: 10px;
        background: var(--card);
        border: 1px solid #222;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 20px;
        cursor: pointer;
        z-index: 100;
        font-size: 18px;
    }

    /* Body Weight Tracker */
    .bodyweight-input {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }
    .bodyweight-input input {
        flex: 1;
        background: #111;
        border: 1px solid #222;
        color: var(--text);
        padding: 12px;
        border-radius: 8px;
    }

    /* Comparison View */
    .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    .comparison-side {
        background: var(--card);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #222;
    }
    .comparison-header {
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 10px;
        font-size: 12px;
    }

    /* Plate Visual */
    .plate-visual {
        margin-top: 15px;
        padding: 20px;
        background: #111;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        overflow-x: auto;
    }
    .plate {
        border: 2px solid;
        border-radius: 4px;
        padding: 8px 4px;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        min-width: 30px;
    }
    .plate-25 { border-color: #ef4444; color: #ef4444; height: 80px; }
    .plate-20 { border-color: #3b82f6; color: #3b82f6; height: 70px; }
    .plate-15 { border-color: #eab308; color: #eab308; height: 60px; }
    .plate-10 { border-color: #22c55e; color: #22c55e; height: 50px; }
    .plate-5 { border-color: #fff; color: #fff; height: 40px; }
    .plate-2-5 { border-color: #888; color: #888; height: 30px; }

    /* Weekly Volume Chart */
    .volume-chart {
        margin-top: 20px;
        padding: 20px;
        background: var(--card);
        border-radius: 12px;
        border: 1px solid #222;
    }

    .tabs { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #222; overflow-x: auto; }
    .tab { padding: 12px 8px; color: var(--dim); cursor: pointer; font-size: 11px; text-transform: uppercase; font-weight: bold; flex: 1; text-align: center; white-space: nowrap; min-width: 70px; }
    .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
    .day-picker { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
    .day { padding: 8px 16px; border-radius: 20px; background: var(--card); font-size: 12px; cursor: pointer; color: var(--dim); white-space: nowrap; }
    .day.active { background: var(--accent); color: white; }
    .day-title-container input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #222; color: var(--accent); font-size: 18px; font-weight: bold; padding: 10px 0; outline: none; margin-bottom: 15px; }
    .add-ex-container { background: #111; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; gap: 10px; border: 1px solid #222; }
    .add-ex-container input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 14px; }
    .quick-select { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 10px; }
    .q-btn { background: #222; color: #fff; border: 1px solid #333; padding: 6px 14px; border-radius: 6px; font-size: 11px; white-space: nowrap; cursor: pointer; }
    
    /* MOBILE-OPTIMIZED Exercise Card */
    .exercise-card { 
        background: var(--card); 
        border-radius: 12px; 
        padding: 15px; 
        margin-bottom: 15px; 
        border: 1px solid #1a1a1a; 
        position: relative; 
    }

    .ex-volume { 
        position: absolute; 
        top: 15px; 
        right: 15px; 
        color: var(--success); 
        font-size: 11px; 
        font-weight: bold;
        background: rgba(22, 163, 74, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .last-workout-ref {
        background: #0a0a0a;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 12px;
        color: var(--dim);
    }
    .last-workout-ref-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }
    .last-workout-ref-content {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #222;
        display: none;
    }
    .last-workout-ref-content.expanded {
        display: block;
    }

    .ex-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        color: var(--accent); 
        font-size: 13px; 
        font-weight: bold; 
        text-transform: uppercase; 
        margin-bottom: 15px; 
    }
    .ex-header-left { 
        display: flex; 
        align-items: center; 
        flex: 1; 
        cursor: pointer; 
    }
    
    .set-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px; 
        padding: 10px; 
        background: #111; 
        border-radius: 6px; 
        font-size: 13px; 
        position: relative; 
    }
    .delete-btn { color: #ff4444; cursor: pointer; font-weight: bold; font-size: 18px; }
    
    /* MOBILE-OPTIMIZED Input Row */
    .input-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 8px; 
        margin-top: 15px; 
    }
    .input-row input { 
        background: #111; 
        border: 2px solid #222; 
        color: white; 
        padding: 18px 12px; 
        border-radius: 8px; 
        text-align: center; 
        font-size: 20px; 
        font-weight: bold;
    }
    .input-row input:focus { 
        border-color: var(--accent); 
        outline: none; 
    }
    .input-row input.input-error { 
        border-color: var(--danger); 
    }
    .input-row button {
        grid-column: 1 / -1;
        padding: 18px;
        font-size: 18px;
        border-radius: 8px;
        background: var(--success);
    }

    /* MOBILE-OPTIMIZED Weight Controls */
    .weight-controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 10px;
    }
    .weight-adjust-btn {
        background: #1a1a1a;
        border: 1px solid #333;
        color: var(--accent);
        padding: 10px 4px;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-size: 10px;
        min-width: auto;
        text-align: center;
    }
    .weight-adjust-btn:active {
        background: var(--accent);
        color: white;
    }

    /* MOBILE-OPTIMIZED Set Type Selector */
    .set-type-selector {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
        margin-top: 10px;
    }
    .type-btn {
        background: #111;
        border: 1px solid #222;
        color: var(--dim);
        padding: 10px 6px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
        text-align: center;
    }
    .type-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }

    .note-input {
        width: 100%;
        background: #111;
        border: 1px solid #222;
        color: var(--text);
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
    }
    
    .feel-select { 
        width: 100%; 
        background: #111; 
        border: 1px solid #222; 
        color: var(--dim); 
        padding: 12px; 
        border-radius: 8px; 
        margin-top: 10px; 
        font-size: 13px; 
    }
    
    .recovery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .recovery-tip { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #222; font-size: 12px; text-align: left; }
    .recovery-tip strong { display: block; color: var(--accent); margin-bottom: 5px; }
    
    /* Timer Banner */
    #timer-banner { 
        position: fixed; 
        bottom: 10px; 
        left: 10px; 
        right: 10px; 
        background: var(--accent); 
        color: white; 
        padding: 15px; 
        display: none; 
        flex-direction: column; 
        gap: 15px; 
        z-index: 1001; 
        border-radius: 12px; 
        transition: background 0.3s;
    }
    .timer-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .timer-ad { background: #fff; border-radius: 8px; padding: 5px; text-align: center; min-height: 60px; display: flex; align-items: center; justify-content: center; }
    
    button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-full { width: 100%; padding: 18px; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; margin-bottom: 20px; }
    .btn-success { background: var(--success); }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--dim); }
    .empty-state-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    .empty-state h3 { color: var(--text); margin-bottom: 10px; }
    .success-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; display: none; font-weight: bold; }
    .history-item { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #1a1a1a; }
    .history-date { color: var(--accent); font-weight: bold; margin-bottom: 10px; font-size: 14px; }
    .history-exercise { padding: 8px 0; border-bottom: 1px solid #1a1a1a; font-size: 13px; }
    .history-exercise:last-child { border-bottom: none; }
    .history-exercise-name { color: var(--text); font-weight: bold; margin-bottom: 5px; }
    .history-sets { color: var(--dim); font-size: 12px; }
    .pr-badge { background: #fbbf24; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
    .stat-card { background: #111; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
    .stat-value { font-size: 32px; font-weight: bold; color: var(--accent); }
    .stat-label { font-size: 11px; color: var(--dim); text-transform: uppercase; margin-top: 5px; }
    .plate-breakdown { background: #111; padding: 15px; border-radius: 8px; margin-top: 15px; }
    .plate-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; color: var(--dim); font-size: 13px; }
    .plate-item:last-child { border-bottom: none; }
    .calc-input-group { margin-bottom: 15px; }
    .calc-input-group label { display: block; color: var(--dim); font-size: 11px; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
    .calc-input-group select, .calc-input-group input { width: 100%; background: #111; border: 1px solid #222; color: white; padding: 15px; border-radius: 8px; font-size: 16px; }

    .settings-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #111;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
    }
    .settings-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    .settings-checkbox label {
        flex: 1;
        cursor: pointer;
        font-size: 14px;
    }

    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
    .file-input-label { display: block; width: 100%; padding: 18px; background: #222; border: 1px solid #333; color: white; text-align: center; border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; margin-bottom: 15px; }
    .repeat-workout-btn { background: #16a34a; margin-bottom: 15px; }
    .ai-insights { background: #111; border: 1px solid #2563eb; }
    .insight-box { padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 10px; }
    .insight-box-header { font-weight: bold; margin-bottom: 5px; font-size: 13px; }
    .insight-box-content { font-size: 13px; color: var(--dim); line-height: 1.5; }
    .insight-suggestion { background: rgba(37, 99, 235, 0.1); padding: 8px 12px; border-radius: 6px; margin-top: 8px; font-size: 12px; border-left: 3px solid var(--accent); }
    .undo-banner { position: fixed; bottom: 90px; left: 10px; right: 10px; background: #333; color: white; padding: 15px; display: none; justify-content: space-between; align-items: center; z-index: 1000; border-radius: 12px; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .search-box { width: 100%; background: #111; border: 1px solid #222; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
    .search-box:focus { border-color: var(--accent); outline: none; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; overflow-y: auto; }
    .modal-content { background: var(--bg); margin: 20px; padding: 20px; border-radius: 12px; max-width: 600px; margin: 20px auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { color: var(--dim); cursor: pointer; font-size: 24px; }
    .filter-group { margin-bottom: 15px; }
    .exercise-grid { display: grid; gap: 12px; margin-top: 20px; }
    .exercise-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid #222; cursor: pointer; }
    .exercise-item:hover { border-color: var(--accent); }
    .exercise-name { color: var(--text); font-weight: bold; margin-bottom: 5px; }
    .exercise-meta { color: var(--dim); font-size: 11px; }
    
    .keyboard-hint {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: var(--card);
        border: 1px solid #222;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        color: var(--dim);
        z-index: 99;
        display: none;
    }

    .compact-sets {
        color: var(--dim);
        font-size: 13px;
        padding: 10px;
        background: #111;
        border-radius: 6px;
    }

    .view-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }
    .view-btn {
        flex: 1;
        background: #111;
        border: 1px solid #222;
        color: var(--dim);
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
    }
    .view-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }

    .streak-banner {
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .streak-icon {
        font-size: 32px;
    }
    .streak-count {
        font-size: 18px;
        font-weight: bold;
        color: white;
    }

    .progress-indicator {
        margin-left: 8px;
        font-size: 14px;
    }
    .progress-up { color: #22c55e; }
    .progress-down { color: #ef4444; }
    .progress-same { color: #888; }

    .time-since {
        font-size: 11px;
        color: var(--dim);
        margin-top: 8px;
        text-align: center;
    }

    .set-delete-reveal {
        position: absolute;
        right: -100px;
        top: 0;
        bottom: 0;
        background: var(--danger);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        font-weight: bold;
        transition: right 0.2s;
    }
    .set-row.swiping .set-delete-reveal {
        right: 0;
    }

    .pr-celebration {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        padding: 30px;
        border-radius: 20px;
        z-index: 9999;
        text-align: center;
        animation: prPop 0.5s forwards;
        box-shadow: 0 20px 60px rgba(251, 191, 36, 0.5);
    }
    .pr-title {
        font-size: 24px;
        font-weight: bold;
        color: #000;
        margin-bottom: 10px;
    }
    .pr-exercise {
        font-size: 18px;
        font-weight: bold;
        color: #000;
        margin-bottom: 8px;
    }
    .pr-detail {
        font-size: 14px;
        color: #000;
        margin: 4px 0;
    }
    @keyframes prPop {
        0% { transform: translate(-50%, -50%) scale(0); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    @media (max-width: 380px) {
        .input-row input {
            font-size: 18px;
            padding: 16px 10px;
        }
        .weight-adjust-btn {
            font-size: 9px;
            padding: 8px 2px;
        }
    }
</style>
</head>
<body>

    <div class="theme-toggle" onclick="toggleTheme()">üåì</div>
    <div class="workout-timer" id="workout-timer">üïê 0:00</div>
    <div class="keyboard-hint" id="keyboard-hint" style="display:none;">‚å®Ô∏è Enter=Add ‚Ä¢ Esc=Clear ‚Ä¢ Space=Timer</div>

    <h1>ZeroLog</h1>
    <div class="tabs">
        <div class="tab active" id="tab-workout" onclick="showSection('workout')">Workout</div>
        <div class="tab" id="tab-history" onclick="showSection('history')">History</div>
        <div class="tab" id="tab-analytics" onclick="showSection('analytics')">Analytics</div>
        <div class="tab" id="tab-calculator" onclick="showSection('calculator')">Calculator</div>
        <div class="tab" id="tab-settings" onclick="showSection('settings')">Settings</div>
    </div>

    <div id="section-workout">
        <div class="day-picker" id="dayPicker"></div>
        <div class="day-title-container"><input type="text" id="day-label-input" placeholder="Today's Focus..." onchange="saveDayLabel()"></div>
        
        <!-- Quick Stats Dashboard -->
        <div class="workout-stats-quick" id="workout-stats-quick" style="display:none;"></div>

        <!-- Templates -->
        <div class="template-bar" id="template-bar"></div>

        <!-- Workout Notes -->
        <div class="workout-notes-section" id="workout-notes-section" style="display:none;">
            <label style="display:block; color:var(--dim); font-size:11px; text-transform:uppercase; font-weight:bold; margin-bottom:8px;">Workout Notes</label>
            <textarea id="workout-notes" placeholder="Energy level, sleep quality, any observations..."></textarea>
        </div>

        <button class="btn-full repeat-workout-btn" id="repeat-btn" onclick="repeatLastWorkout()" style="display:none;">üîÑ Repeat Last Workout</button>
        <button class="btn-full" style="margin-bottom: 15px; background: #16a34a;" onclick="openExerciseLibrary()">üìö Browse Exercise Library</button>
        <div class="add-ex-container"><input type="text" id="new-ex-name" placeholder="Add New Exercise..."><button onclick="addExercise()" aria-label="Add exercise">ADD</button></div>
        <input type="text" class="search-box" id="exercise-search" placeholder="üîç Search exercises..." oninput="filterQuickSelect()" style="display:none;">
        <div class="quick-select" id="quickSelect"></div>
        <div id="workoutArea"></div>
        <button class="btn-full btn-success" id="complete-btn" onclick="completeWorkout()" style="display:none;">Finish & Log Workout</button>
        <button class="btn-full" id="rest-btn-toggle" onclick="toggleRestDay()">Mark as Rest Day</button>
    </div>

    <div id="section-history" style="display:none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-workouts">0</div>
                <div class="stat-label">Total Workouts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-volume">0</div>
                <div class="stat-label">Total Volume (kg)</div>
            </div>
        </div>
        
        <!-- Comparison View -->
        <button class="btn-full" style="margin-bottom:15px; background:#8b5cf6;" onclick="showComparison()">Compare with Last Week</button>
        
        <div id="historyArea"></div>
    </div>

    <div id="section-analytics" style="display:none;">
<div id="muscle-volume-section"></div>
        <!-- Body Weight Tracker -->
        <div class="exercise-card">
            <h3>Body Weight Tracking</h3>
            <div class="bodyweight-input">
                <input type="number" id="bodyweight-input" placeholder="Enter weight (kg)" step="0.1">
                <button onclick="logBodyWeight()">Log</button>
            </div>
            <canvas id="bodyweight-chart"></canvas>
        </div>

        <!-- Weekly Volume Chart -->
        <div class="volume-chart">
            <h3>Weekly Volume Trend</h3>
            <canvas id="volume-chart"></canvas>
        </div>

        <!-- Deload Suggestion -->
        <div class="exercise-card" id="deload-suggestion"></div>
    </div>

    <div id="section-calculator" style="display:none;">
        <div class="exercise-card">
            <h3>Plate Calculator</h3>
            <div class="calc-input-group">
                <label>Bar Weight</label>
                <select id="bar-weight">
                    <option value="20">Olympic Bar (20kg)</option>
                    <option value="15">Women's Bar (15kg)</option>
                    <option value="10">Standard Bar (10kg)</option>
                    <option value="7">Training Bar (7kg)</option>
                </select>
            </div>
            <div class="calc-input-group">
                <label>Total Weight</label>
                <input type="number" id="target-weight" placeholder="Total Weight (kg)" inputmode="decimal">
            </div>
            <div id="calc-result" style="text-align:center; color:var(--accent); font-weight:bold; font-size:24px; margin:20px 0;"></div>
            <div id="plate-visual" class="plate-visual"></div>
            <div id="plate-breakdown"></div>
            <button onclick="calcPlates()" style="width:100%">Calculate Per Side</button>
        </div>

        <div class="exercise-card">
            <h3>One Rep Max Calculator</h3>
            <div class="calc-input-group">
                <label>Weight Lifted (kg)</label>
                <input type="number" id="orm-weight" placeholder="Weight" inputmode="decimal">
            </div>
            <div class="calc-input-group">
                <label>Reps Completed</label>
                <input type="number" id="orm-reps" placeholder="Reps" inputmode="numeric">
            </div>
            <div id="orm-result" style="text-align:center; color:var(--accent); font-weight:bold; font-size:24px; margin:20px 0;"></div>
            <button onclick="calcORM()" style="width:100%">Calculate 1RM</button>
        </div>

        <div class="exercise-card">
            <h3>Warmup Calculator</h3>
            <div class="calc-input-group">
                <label>Working Weight (kg)</label>
                <input type="number" id="warmup-target" placeholder="e.g., 100" inputmode="decimal">
            </div>
            <button onclick="calcWarmup()" style="width:100%; margin-bottom:10px;">Generate Warmup Sets</button>
            <div id="warmup-sets" class="warmup-calculator"></div>
        </div>
    </div>

    <div id="section-settings" style="display:none;">
        <div class="exercise-card">
            <h3>Timer Settings</h3>
            <div class="calc-input-group">
                <label>Default Rest Timer (seconds)</label>
                <input type="number" id="default-timer" placeholder="90" value="90" min="30" max="300">
            </div>

            <div class="settings-checkbox" onclick="toggleAutoStartTimer()">
                <input type="checkbox" id="auto-start-timer" onchange="saveAutoStartTimer()">
                <label for="auto-start-timer">Auto-start timer after each set</label>
            </div>

            <button onclick="saveTimerSettings()" style="width:100%; margin-bottom: 20px;">Save Timer Settings</button>
        </div>

        <div class="exercise-card">
            <h3>Custom Quick Exercises</h3>
            <div class="add-ex-container" style="margin-bottom: 15px;">
                <input type="text" id="custom-exercise" placeholder="Add to quick select...">
                <button onclick="addCustomExercise()">ADD</button>
            </div>
            <div id="custom-exercises-list" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>

        <div class="exercise-card">
            <h3>Workout Templates</h3>
            <button class="btn-full" style="background:#8b5cf6; margin-bottom:10px;" onclick="saveAsTemplate()">üíæ Save Current as Template</button>
            <div id="templates-list"></div>
        </div>

        <div class="exercise-card">
            <h3>Exercise Notes</h3>
            <p style="font-size:12px; color:var(--dim); margin-bottom:10px;">Save personal notes for each exercise (form cues, tips, etc.)</p>
            <button class="btn-full" style="background:#8b5cf6;" onclick="openExerciseNotes()">Manage Exercise Notes</button>
        </div>

        <div class="exercise-card">
            <h3>Data Management</h3>
            <button class="btn-full" style="background:#222; border: 1px solid #333; margin-bottom:15px;" onclick="exportData()">üì• Export Data (JSON)</button>
            <button class="btn-full" style="background:#222; border: 1px solid #333; margin-bottom:15px;" onclick="exportCSV()">üìä Export History (CSV)</button>
            <div class="file-input-wrapper">
                <input type="file" id="import-file" accept=".json" onchange="importData(event)">
                <label for="import-file" class="file-input-label">üì§ Import Data (JSON)</label>
            </div>
            <button class="btn-full" style="background:#16a34a; margin-bottom:15px;" onclick="downloadHTML()">üíæ Download HTML File</button>
            <button class="btn-full" style="background:var(--danger);" onclick="resetData()">Reset All Data</button>
        </div>
    </div>

    <!-- Quick Timer Bar -->
    <div class="quick-timer-bar" id="quick-timer-bar">
        <button class="quick-timer-btn" onclick="startTimer(30)">30s</button>
        <button class="quick-timer-btn" onclick="startTimer(60)">60s</button>
        <button class="quick-timer-btn" onclick="startTimer(90)">90s</button>
        <button class="quick-timer-btn" onclick="startTimer(120)">120s</button>
        <button class="quick-timer-btn" onclick="startTimer(180)">180s</button>
        <button class="quick-timer-btn" style="background:#333;" onclick="hideQuickTimer()">‚úï</button>
    </div>

    <div id="exercise-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Exercise Library</h2>
                <span class="modal-close" onclick="closeExerciseLibrary()">√ó</span>
            </div>
            <div class="filter-group">
                <input type="text" class="search-box" id="exercise-lib-search" placeholder="Search exercises..." oninput="filterExerciseLibrary()">
            </div>
            <div class="filter-group">
                <label style="color: var(--dim); font-size: 11px; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 8px;">Muscle Group</label>
                <select id="muscle-filter" onchange="filterExerciseLibrary()" style="width: 100%; background: #111; border: 1px solid #222; color: white; padding: 12px; border-radius: 8px;">
                    <option value="">All Muscles</option>
                    <option value="chest">Chest</option>
                    <option value="back">Back</option>
                    <option value="legs">Legs</option>
                    <option value="shoulders">Shoulders</option>
                    <option value="arms">Arms</option>
                    <option value="core">Core</option>
                </select>
            </div>
            <div class="filter-group">
                <label style="color: var(--dim); font-size: 11px; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 8px;">Equipment</label>
                <select id="equipment-filter" onchange="filterExerciseLibrary()" style="width: 100%; background: #111; border: 1px solid #222; color: white; padding: 12px; border-radius: 8px;">
                    <option value="">All Equipment</option>
                    <option value="barbell">Barbell</option>
                    <option value="dumbbell">Dumbbell</option>
                    <option value="cable">Cable</option>
                    <option value="machine">Machine</option>
                    <option value="bodyweight">Bodyweight</option>
                </select>
            </div>
            <div id="exercise-library-list" class="exercise-grid"></div>
        </div>
    </div>

    <!-- Exercise History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;" id="history-modal-title">Exercise History</h2>
                <span class="modal-close" onclick="closeHistoryModal()">√ó</span>
            </div>
            <div class="history-chart-container">
                <canvas id="exercise-history-chart"></canvas>
            </div>
            <div id="exercise-history-details"></div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Workout Comparison</h2>
                <span class="modal-close" onclick="closeComparisonModal()">√ó</span>
            </div>
            <div id="comparison-content"></div>
        </div>
    </div>

    <!-- Exercise Notes Modal -->
    <div id="notes-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0;">Exercise Notes</h2>
                <span class="modal-close" onclick="closeNotesModal()">√ó</span>
            </div>
            <div id="notes-content"></div>
        </div>
    </div>

    <div id="timer-banner">
        <div class="timer-content">
            <div>
                <div style="font-size:10px; opacity:0.8;">RESTING</div>
                <div id="timer-display" style="font-size:24px; font-weight:900">0:00</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
                <button onclick="startTimer(60)">60s</button>
                <button onclick="startTimer(90)">90s</button>
                <button onclick="startTimer(180)">180s</button>
                <button onclick="stopTimer()" style="background:#000">SKIP</button>
            </div>
        </div>
        <div class="timer-ad" id="timer-ad-container">
            <ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-9180492943097575" data-ad-slot="2575154803"></ins>
        </div>
    </div>
    <div id="undo-banner" class="undo-banner">
        <span id="undo-message">Set deleted</span>
        <button onclick="undoDelete()" style="padding: 8px 16px;">UNDO</button>
    </div>

    <div id="success-indicator" class="success-indicator">‚úì Set Added!</div>
    <script>
        let currentDay = new Date().toLocaleDateString('en-US', { weekday: 'short' });
        let workouts = [], restDays = [], dayLabels = {}, history = [], customExercises = [];
        let timerInterval, undoStack = [], defaultTimer = 90, exerciseDatabase = [], filteredExercises = [];
        let workoutStartTime = null, workoutTimerInterval = null, autoStartTimer = false;
        let lastTap = 0, touchStartX = 0, touchEndX = 0, compactView = false, workoutStreak = 0;
        let lastSetTime = {}, theme = 'dark';
        
        // NEW: Additional data structures
        let templates = [], volumeTargets = {}, exerciseNotes = {}, bodyWeightLog = [], workoutNotes = {};
        let draggedExercise = null;

        const daysList = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const quickExList = ['Bench Press', 'Squat', 'Deadlift', 'Shoulder Press', 'Lat Pulldown', 'Barbell Row', 'Leg Press', 'Bicep Curl'];
        const muscleGroups = {
            push: ['Bench Press', 'Shoulder Press', 'Incline Press', 'Overhead Press', 'Dumbbell Press', 'Chest Fly', 'Tricep Extension', 'Dips'],
            pull: ['Lat Pulldown', 'Barbell Row', 'Pull Up', 'Deadlift', 'Face Pull', 'Cable Row', 'T-Bar Row', 'Chin Up'],
            legs: ['Squat', 'Leg Press', 'Lunges', 'Leg Curl', 'Leg Extension', 'Romanian Deadlift', 'Hack Squat', 'Bulgarian Split Squat'],
            arms: ['Bicep Curl', 'Hammer Curl', 'Preacher Curl', 'Concentration Curl', 'Tricep Pushdown']
        };
        const RAPIDAPI_KEY = 'YOUR_RAPIDAPI_KEY_HERE';

        function loadData() {
            try {
                workouts = JSON.parse(localStorage.getItem('zerolog_data')) || [];
                restDays = JSON.parse(localStorage.getItem('zerolog_rest_days')) || [];
                dayLabels = JSON.parse(localStorage.getItem('zerolog_day_labels')) || {};
                history = JSON.parse(localStorage.getItem('zerolog_history')) || [];
                customExercises = JSON.parse(localStorage.getItem('zerolog_custom_exercises')) || [];
                defaultTimer = parseInt(localStorage.getItem('zerolog_default_timer')) || 90;
                autoStartTimer = JSON.parse(localStorage.getItem('zerolog_auto_start_timer')) || false;
                compactView = JSON.parse(localStorage.getItem('zerolog_compact_view')) || false;
                theme = localStorage.getItem('zerolog_theme') || 'dark';
                templates = JSON.parse(localStorage.getItem('zerolog_templates')) || [];
                volumeTargets = JSON.parse(localStorage.getItem('zerolog_volume_targets')) || {};
                exerciseNotes = JSON.parse(localStorage.getItem('zerolog_exercise_notes')) || {};
                bodyWeightLog = JSON.parse(localStorage.getItem('zerolog_bodyweight')) || [];
                workoutNotes = JSON.parse(localStorage.getItem('zerolog_workout_notes')) || {};
                calculateStreak();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // Theme Toggle
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('zerolog_theme', theme);
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement.id === 'new-ex-name') { e.preventDefault(); addExercise(); }
                if (activeElement.id && (activeElement.id.startsWith('w-') || activeElement.id.startsWith('r-'))) {
                    e.preventDefault();
                    const exId = parseInt(activeElement.id.split('-')[1]);
                    addSet(exId);
                }
                if (activeElement.id === 'custom-exercise') { e.preventDefault(); addCustomExercise(); }
            }
            if (e.key === 'Escape') {
                const inputs = document.querySelectorAll('input[type="number"]');
                inputs.forEach(inp => inp.value = '');
            }
            if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                showQuickTimer();
            }
        });

        function showQuickTimer() {
            const bar = document.getElementById('quick-timer-bar');
            bar.classList.add('active');
        }

        function hideQuickTimer() {
            const bar = document.getElementById('quick-timer-bar');
            bar.classList.remove('active');
        }

        // Quick Stats Dashboard
        function renderQuickStats() {
            const dailyEx = workouts.filter(ex => ex.day === currentDay);
            if (dailyEx.length === 0 || !dailyEx.some(ex => ex.sets.length > 0)) {
                document.getElementById('workout-stats-quick').style.display = 'none';
                return;
            }

            const totalVolume = dailyEx.reduce((sum, ex) => sum + calculateExerciseVolume(ex.sets), 0);
            const totalSets = dailyEx.reduce((sum, ex) => sum + ex.sets.length, 0);
            const avgWeight = dailyEx.length > 0 ? 
                dailyEx.reduce((sum, ex) => {
                    if (ex.sets.length === 0) return sum;
                    const exAvg = ex.sets.reduce((s, set) => s + parseFloat(set.weight), 0) / ex.sets.length;
                    return sum + exAvg;
                }, 0) / dailyEx.filter(ex => ex.sets.length > 0).length : 0;

            const container = document.getElementById('workout-stats-quick');
            container.style.display = 'grid';
            container.innerHTML = `
                <div class="stat-quick">
                    <div class="stat-quick-value">${Math.round(totalVolume)}</div>
                    <div class="stat-quick-label">Volume (kg)</div>
                </div>
                <div class="stat-quick">
                    <div class="stat-quick-value">${totalSets}</div>
                    <div class="stat-quick-label">Total Sets</div>
                </div>
                <div class="stat-quick">
                    <div class="stat-quick-value">${avgWeight.toFixed(1)}</div>
                    <div class="stat-quick-label">Avg Weight</div>
                </div>
            `;
        }

        // Template Management
        function saveAsTemplate() {
            const name = prompt('Template name:');
            if (!name) return;
            
            const dailyEx = workouts.filter(ex => ex.day === currentDay);
            if (dailyEx.length === 0) {
                alert('No exercises to save!');
                return;
            }

            templates.push({
                id: Date.now(),
                name: name,
                exercises: dailyEx.map(ex => ({name: ex.name, supersetWith: ex.supersetWith || null}))
            });

            try {
                localStorage.setItem('zerolog_templates', JSON.stringify(templates));
            } catch(e) {}

            renderTemplates();
            alert('Template saved!');
        }

        function loadTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            if (workouts.filter(ex => ex.day === currentDay).length > 0) {
                if (!confirm('This will clear current exercises. Continue?')) return;
            }

            workouts = workouts.filter(ex => ex.day !== currentDay);
            
            template.exercises.forEach(ex => {
                workouts.push({
                    id: Date.now() + Math.random(),
                    day: currentDay,
                    name: ex.name,
                    sets: [],
                    feeling: '',
                    supersetWith: ex.supersetWith
                });
            });

            save();
        }

        function deleteTemplate(id) {
            if (!confirm('Delete this template?')) return;
            templates = templates.filter(t => t.id !== id);
            try {
                localStorage.setItem('zerolog_templates', JSON.stringify(templates));
            } catch(e) {}
            renderTemplates();
        }

        function renderTemplates() {
            const bar = document.getElementById('template-bar');
            if (templates.length === 0) {
                bar.innerHTML = '';
                return;
            }

            bar.innerHTML = templates.map(t => 
                `<div class="template-btn" onclick="loadTemplate(${t.id})">${t.name}</div>`
            ).join('');

            const list = document.getElementById('templates-list');
            list.innerHTML = templates.map(t =>
                `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#111; border-radius:8px; margin-bottom:8px;">
                    <span>${t.name} (${t.exercises.length} exercises)</span>
                    <span class="delete-btn" onclick="deleteTemplate(${t.id})">‚úï</span>
                </div>`
            ).join('');
        }

        // Exercise Notes
        function openExerciseNotes() {
            const modal = document.getElementById('notes-modal');
            modal.style.display = 'block';
            
            const allExercises = [...new Set([
                ...quickExList,
                ...customExercises,
                ...history.flatMap(h => h.exercises.map(e => e.name))
            ])].sort();

            const content = document.getElementById('notes-content');
            content.innerHTML = allExercises.map(ex => `
                <div class="exercise-card">
                    <h4 style="margin:0 0 10px 0;">${ex}</h4>
                    <textarea id="note-${ex.replace(/\s+/g, '-')}" style="width:100%; background:#111; border:1px solid #222; color:var(--text); padding:10px; border-radius:8px; font-size:12px; min-height:60px;" placeholder="Form cues, tips, observations...">${exerciseNotes[ex] || ''}</textarea>
                    <button onclick="saveExerciseNote('${ex.replace(/'/g, "\\'")}', 'note-${ex.replace(/\s+/g, '-')}')" style="width:100%; margin-top:10px;">Save</button>
                </div>
            `).join('');
        }

        function saveExerciseNote(exName, inputId) {
            const note = document.getElementById(inputId).value;
            if (note.trim()) {
                exerciseNotes[exName] = note.trim();
            } else {
                delete exerciseNotes[exName];
            }
            try {
                localStorage.setItem('zerolog_exercise_notes', JSON.stringify(exerciseNotes));
            } catch(e) {}
            showSuccessIndicator();
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
        }

        // Body Weight Tracking
        function logBodyWeight() {
            const weight = parseFloat(document.getElementById('bodyweight-input').value);
            if (!weight || weight <= 0) {
                alert('Enter valid weight');
                return;
            }

            bodyWeightLog.push({
                date: new Date().toISOString(),
                weight: weight
            });

            try {
                localStorage.setItem('zerolog_bodyweight', JSON.stringify(bodyWeightLog));
            } catch(e) {}

            document.getElementById('bodyweight-input').value = '';
            renderBodyWeightChart();
            showSuccessIndicator();
        }

        function renderBodyWeightChart() {
            if (bodyWeightLog.length === 0) return;

            const canvas = document.getElementById('bodyweight-chart');
            const ctx = canvas.getContext('2d');

            const sortedLog = [...bodyWeightLog].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedLog.map(l => new Date(l.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            const data = sortedLog.map(l => l.weight);

            if (window.bodyweightChart) window.bodyweightChart.destroy();

            window.bodyweightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Body Weight (kg)',
                        data: data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Weekly Volume Chart
        function renderVolumeChart() {
            const canvas = document.getElementById('volume-chart');
            const ctx = canvas.getContext('2d');

            const weeks = [];
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - (7 * i));
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                const weekWorkouts = history.filter(h => {
                    const d = new Date(h.date);
                    return d >= weekStart && d < weekEnd;
                });

                const volume = weekWorkouts.reduce((sum, w) => {
                    return sum + w.exercises.reduce((exSum, ex) => {
                        return exSum + calculateExerciseVolume(ex.sets);
                    }, 0);
                }, 0);

                weeks.push({
                    label: weekStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}),
                    volume: Math.round(volume)
                });
            }

            if (window.volumeChart) window.volumeChart.destroy();

            window.volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks.map(w => w.label),
                    datasets: [{
                        label: 'Weekly Volume (kg)',
                        data: weeks.map(w => w.volume),
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Deload Detection
        function renderDeloadSuggestion() {
            const fatigue = calculateFatigueScore();
            if (!fatigue) return;

            const container = document.getElementById('deload-suggestion');
            
            if (fatigue.score > 70) {
                container.innerHTML = `
                    <h3 style="color:var(--danger);">‚ö†Ô∏è Deload Recommended</h3>
                    <p>${fatigue.recommendation.message}</p>
                    <button onclick="createDeloadWeek()" style="width:100%; background:var(--warning);">Create Deload Week</button>
                `;
            } else {
                container.innerHTML = `
                    <h3 style="color:var(--success);">‚úÖ Recovery Status: Good</h3>
                    <p>${fatigue.recommendation.message}</p>
                `;
            }
        }

        function createDeloadWeek() {
            if (!confirm('This will reduce all working weights by 30% for this week. Continue?')) return;

            workouts = workouts.map(ex => {
                return {
                    ...ex,
                    sets: ex.sets.map(set => ({
                        ...set,
                        weight: (parseFloat(set.weight) * 0.7).toFixed(1)
                    }))
                };
            });

            save();
            alert('Deload week created! Weights reduced by 30%');
        }

        // Warmup Calculator
        function calcWarmup() {
            const target = parseFloat(document.getElementById('warmup-target').value);
            if (!target || target <= 0) {
                alert('Enter working weight');
                return;
            }

            const warmups = [
                { pct: 0.4, reps: 8 },
                { pct: 0.6, reps: 5 },
                { pct: 0.8, reps: 3 }
            ];

            const container = document.getElementById('warmup-sets');
            container.innerHTML = '<strong style="color:var(--accent); display:block; margin-bottom:10px;">Suggested Warmup:</strong>' +
                warmups.map((w, i) => {
                    const weight = (target * w.pct).toFixed(1);
                    return `<div class="warmup-set">Set ${i+1}: ${weight}kg √ó ${w.reps} reps</div>`;
                }).join('');
        }

        // Plate Visual
        function renderPlateVisual(perSide) {
            const plates = [
                {weight: 25, color: '#ef4444', class: 'plate-25'},
                {weight: 20, color: '#3b82f6', class: 'plate-20'},
                {weight: 15, color: '#eab308', class: 'plate-15'},
                {weight: 10, color: '#22c55e', class: 'plate-10'},
                {weight: 5, color: '#fff', class: 'plate-5'},
                {weight: 2.5, color: '#888', class: 'plate-2-5'}
            ];

            let remaining = perSide;
            let visual = [];

            for (let plate of plates) {
                let count = Math.floor(remaining / plate.weight);
                for (let i = 0; i < count; i++) {
                    visual.push(`<div class="plate ${plate.class}">${plate.weight}</div>`);
                }
                remaining -= count * plate.weight;
            }

            const container = document.getElementById('plate-visual');
            if (visual.length > 0) {
                container.innerHTML = '<div style="min-width:40px; height:60px; background:#333; border-radius:4px;"></div>' +
                    visual.join('') +
                    '<div style="min-width:40px; height:60px; background:#333; border-radius:4px;"></div>';
            } else {
                container.innerHTML = '';
            }
        }

        // Exercise History Modal
        function showExerciseHistory(exName) {
            const modal = document.getElementById('history-modal');
            document.getElementById('history-modal-title').textContent = exName;
            modal.style.display = 'block';

            const exHistory = history.flatMap(h => {
                const ex = h.exercises.find(e => e.name === exName);
                return ex ? [{date: h.date, sets: ex.sets}] : [];
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (exHistory.length === 0) {
                document.getElementById('exercise-history-details').innerHTML = '<p style="text-align:center; color:var(--dim);">No history found</p>';
                return;
            }

            // Chart
            const canvas = document.getElementById('exercise-history-chart');
            const ctx = canvas.getContext('2d');

            const labels = exHistory.map(h => new Date(h.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            const maxWeights = exHistory.map(h => Math.max(...h.sets.map(s => parseFloat(s.weight))));
            const volumes = exHistory.map(h => calculateExerciseVolume(h.sets));

            if (window.exerciseHistoryChart) window.exerciseHistoryChart.destroy();

            window.exerciseHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Max Weight (kg)',
                            data: maxWeights,
                            borderColor: '#2563eb',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Volume (kg)',
                            data: volumes,
                            borderColor: '#16a34a',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            // Details
            const details = document.getElementById('exercise-history-details');
            details.innerHTML = exHistory.slice(-5).reverse().map(h => {
                const date = new Date(h.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                return `<div style="padding:10px; background:var(--card); border-radius:8px; margin-top:10px;">
                    <strong>${date}</strong><br>
                    <span style="font-size:12px; color:var(--dim);">${h.sets.map(s => `${s.weight}kg √ó ${s.reps}`).join(' ‚Ä¢ ')}</span>
                </div>`;
            }).join('');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }

        // Comparison View
        function showComparison() {
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            const thisWeekWorkouts = history.filter(h => new Date(h.date) >= lastWeek);
            const prevWeekStart = new Date(lastWeek);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const lastWeekWorkouts = history.filter(h => {
                const d = new Date(h.date);
                return d >= prevWeekStart && d < lastWeek;
            });

            const modal = document.getElementById('comparison-modal');
            modal.style.display = 'block';

            const thisWeekVolume = thisWeekWorkouts.reduce((sum, w) => 
                sum + w.exercises.reduce((exSum, ex) => exSum + calculateExerciseVolume(ex.sets), 0), 0
            );
            const lastWeekVolume = lastWeekWorkouts.reduce((sum, w) => 
                sum + w.exercises.reduce((exSum, ex) => exSum + calculateExerciseVolume(ex.sets), 0), 0
            );

            const content = document.getElementById('comparison-content');
            content.innerHTML = `
                <div class="comparison-container">
                    <div class="comparison-side">
                        <div class="comparison-header">Last Week</div>
                        <div style="font-size:24px; font-weight:bold; color:var(--accent); margin:10px 0;">${Math.round(lastWeekVolume)}kg</div>
                        <div style="font-size:12px; color:var(--dim);">${lastWeekWorkouts.length} workouts</div>
                    </div>
                    <div class="comparison-side">
                        <div class="comparison-header">This Week</div>
                        <div style="font-size:24px; font-weight:bold; color:var(--accent); margin:10px 0;">${Math.round(thisWeekVolume)}kg</div>
                        <div style="font-size:12px; color:var(--dim);">${thisWeekWorkouts.length} workouts</div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px; padding:15px; background:var(--card); border-radius:8px;">
                    <strong style="color:${thisWeekVolume > lastWeekVolume ? 'var(--success)' : 'var(--danger)'};">
                        ${thisWeekVolume > lastWeekVolume ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} 
                        ${Math.abs(((thisWeekVolume - lastWeekVolume) / lastWeekVolume * 100).toFixed(1))}% 
                        ${thisWeekVolume > lastWeekVolume ? 'increase' : 'decrease'}
                    </strong>
                </div>
            `;
        }

        function closeComparisonModal() {
            document.getElementById('comparison-modal').style.display = 'none';
        }

        // CSV Export
        function exportCSV() {
            if (history.length === 0) {
                alert('No history to export');
                return;
            }

            let csv = 'Date,Day,Exercise,Set,Weight (kg),Reps,Type,Feeling\n';
            
            history.forEach(workout => {
                const date = new Date(workout.date).toLocaleDateString();
                const day = workout.label || '';
                
                workout.exercises.forEach(ex => {
                    ex.sets.forEach((set, i) => {
                        csv += `${date},${day},${ex.name},${i+1},${set.weight},${set.reps},${set.type || 'working'},${ex.feeling || ''}\n`;
                    });
                });
            });

            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `zerolog_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Enhanced Plate Calculator
        function calcPlates() {
            const t = parseFloat(document.getElementById('target-weight').value);
            const b = parseFloat(document.getElementById('bar-weight').value);
            const r = document.getElementById('calc-result');
            const br = document.getElementById('plate-breakdown');
            
            if(!t || t < b) {
                r.innerText = `Min ${b}kg`;
                br.innerHTML = '';
                document.getElementById('plate-visual').innerHTML = '';
                return;
            }
            
            const p = (t - b) / 2;
            r.innerText = `${p.toFixed(1)} kg/side`;
            
            renderPlateVisual(p);
            
            const plates = [25, 20, 15, 10, 5, 2.5, 1.25, 0.5];
            let rem = p;
            let bd = [];
            
            for(let pl of plates) {
                let c = Math.floor(rem / pl);
                if(c > 0) {
                    bd.push({weight: pl, count: c});
                    rem -= c * pl;
                }
            }
            
            if(bd.length > 0) {
                br.innerHTML = '<div class="plate-breakdown"><strong style="color:var(--accent);display:block;margin-bottom:10px;">Plates Per Side:</strong>' + 
                    bd.map(p => `<div class="plate-item"><span>${p.count}x ${p.weight}kg</span></div>`).join('') + '</div>';
            } else {
                br.innerHTML = '';
            }
        }

        function calculateStreak() {
            if (history.length === 0) { workoutStreak = 0; return; }
            const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            const today = new Date(); today.setHours(0, 0, 0, 0);
            let streak = 0, checkDate = new Date(today);
            
            for (let i = 0; i < 365; i++) {
                const hasWorkout = sortedHistory.some(w => {
                    const workoutDate = new Date(w.date);
                    workoutDate.setHours(0, 0, 0, 0);
                    return workoutDate.getTime() === checkDate.getTime();
                });
                if (hasWorkout) { 
                    streak++; 
                    checkDate.setDate(checkDate.getDate() - 1); 
                } else if (i === 0) { 
                    checkDate.setDate(checkDate.getDate() - 1); 
                } else { 
                    break; 
                }
            }
            workoutStreak = streak;
        }

        function startWorkoutTimer() {
            if (workoutStartTime) return;
            workoutStartTime = Date.now();
            const timerDisplay = document.getElementById('workout-timer');
            timerDisplay.classList.add('active');

            workoutTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - workoutStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timerDisplay.textContent = `üïê ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopWorkoutTimer() {
            if (workoutTimerInterval) clearInterval(workoutTimerInterval);
            workoutStartTime = null;
            workoutTimerInterval = null;
            document.getElementById('workout-timer').classList.remove('active');
        }

        function getLastWorkoutForExercise(exName) {
            const dayWorkouts = history.filter(h => {
                const date = new Date(h.date);
                const workoutDay = date.toLocaleDateString('en-US', {weekday: 'short'});
                return workoutDay === currentDay;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));

            for (let workout of dayWorkouts) {
                const exercise = workout.exercises.find(e => e.name === exName);
                if (exercise && exercise.sets.length > 0) return exercise;
            }
            return null;
        }

        function toggleLastWorkoutRef(exId) {
            const content = document.getElementById(`last-workout-${exId}`);
            if (content) {
                content.classList.toggle('expanded');
            }
        }

        function adjustWeight(exId, amount) {
            const input = document.getElementById(`w-${exId}`);
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + amount);
            input.value = newValue % 1 === 0 ? newValue : newValue.toFixed(1);

            if (navigator.vibrate) navigator.vibrate(10);
        }

        function calculateExerciseVolume(sets) {
            return sets.reduce((total, set) => total + (parseFloat(set.weight) * parseInt(set.reps)), 0);
        }

        function toggleAutoStartTimer() {
            const checkbox = document.getElementById('auto-start-timer');
            checkbox.checked = !checkbox.checked;
            saveAutoStartTimer();
        }

        function saveAutoStartTimer() {
            autoStartTimer = document.getElementById('auto-start-timer').checked;
            try {
                localStorage.setItem('zerolog_auto_start_timer', JSON.stringify(autoStartTimer));
            } catch(e) {}
        }

        function handleWeightInputTap(exId) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                const workout = workouts.find(w => w.id === exId);
                if (workout && workout.sets.length > 0) {
                    const lastSet = workout.sets[workout.sets.length - 1];
                    document.getElementById(`w-${exId}`).value = lastSet.weight;
                    document.getElementById(`r-${exId}`).value = lastSet.reps;
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            }
            lastTap = currentTime;
        }

        function handleSwipeStart(e, exId, setIndex) { touchStartX = e.touches[0].clientX; }
        
        function handleSwipeMove(e, exId, setIndex) {
            touchEndX = e.touches[0].clientX;
            const diff = touchStartX - touchEndX;
            if (diff > 50) {
                const row = e.target.closest('.set-row');
                if (row) row.classList.add('swiping');
            }
        }
        
        function handleSwipeEnd(e, exId, setIndex) {
            const diff = touchStartX - touchEndX;
            const row = e.target.closest('.set-row');
            if (diff > 100) { deleteSet(exId, setIndex); }
            if (row) row.classList.remove('swiping');
        }

        function showPRCelebration(exerciseName, newWeight, oldWeight) {
            const banner = document.createElement('div');
            banner.className = 'pr-celebration';
            banner.innerHTML = `
                <div class="pr-title">üéâ NEW PR! üéâ</div>
                <div class="pr-exercise">${exerciseName}</div>
                <div class="pr-detail">${newWeight}kg</div>
                <div class="pr-detail">Previous: ${oldWeight}kg (+${(newWeight - oldWeight).toFixed(1)}kg)</div>
            `;
            document.body.appendChild(banner);
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 }, colors: ['#fbbf24', '#f59e0b', '#ffffff'] });
            setTimeout(() => {
                banner.style.animation = 'prPop 0.3s reverse';
                setTimeout(() => banner.remove(), 300);
            }, 3000);
        }

        function checkForPR(exName, weight) {
    const isNewPR = updatePR(exName, weight);
    if (isNewPR && personalRecords[exName] !== parseFloat(weight)) {
        // Only show celebration if beating old PR, not first time
        showPRCelebration(exName, parseFloat(weight), personalRecords[exName] || 0);
    }
    return isNewPR;
}

        function getProgressIndicator(exName, weight, reps) {
            const lastWorkout = getLastWorkoutForExercise(exName);
            if (!lastWorkout || lastWorkout.sets.length === 0) return '';
            const lastAvgWeight = lastWorkout.sets.reduce((sum, s) => sum + parseFloat(s.weight), 0) / lastWorkout.sets.length;
            const currentWeight = parseFloat(weight);
            if (currentWeight > lastAvgWeight) return '<span class="progress-indicator progress-up">‚ÜóÔ∏è</span>';
            else if (currentWeight < lastAvgWeight) return '<span class="progress-indicator progress-down">‚ÜòÔ∏è</span>';
            else return '<span class="progress-indicator progress-same">‚Üí</span>';
        }

        function getTimeSinceLastSet(exId) {
            if (!lastSetTime[exId]) return '';
            const now = Date.now();
            const diff = Math.floor((now - lastSetTime[exId]) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')} since last set`;
        }

        function toggleCompactView() {
            compactView = !compactView;
            try { localStorage.setItem('zerolog_compact_view', JSON.stringify(compactView)); } catch(e) {}
            render();
        }

        function init() {
            loadData();
            loadPRs();
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('dayPicker').innerHTML = daysList.map(d => 
                `<div class="day ${d === currentDay ? 'active' : ''}" onclick="setDay('${d}')">${d}</div>`
            ).join('');
            renderQuickSelect();
            renderCustomExercises();
            renderTemplates();
            document.getElementById('day-label-input').value = dayLabels[currentDay] || '';
            document.getElementById('default-timer').value = defaultTimer;
            document.getElementById('auto-start-timer').checked = autoStartTimer;
            document.getElementById('workout-notes').value = workoutNotes[currentDay] || '';
            
            const lastWorkout = getLastWorkoutForDay(currentDay);
            const repeatBtn = document.getElementById('repeat-btn');
            repeatBtn.style.display = (lastWorkout && !restDays.includes(currentDay)) ? 'block' : 'none';
            
            render();
            loadExerciseDatabase();
            
            // Show keyboard hints if desktop
            if (window.innerWidth > 768) {
                document.getElementById('keyboard-hint').style.display = 'block';
            }
        }

        function setDay(d) { 
            currentDay = d; 
            init(); 
        }
        
        function saveDayLabel() {
            dayLabels[currentDay] = document.getElementById('day-label-input').value;
            try { localStorage.setItem('zerolog_day_labels', JSON.stringify(dayLabels)); } catch (e) {}
        }
        
        function showSection(s) {
            ['workout', 'history', 'analytics', 'calculator', 'settings'].forEach(sec => {
                document.getElementById('section-' + sec).style.display = (s === sec) ? 'block' : 'none';
            });
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + s).classList.add('active');
            
            if (s === 'history') renderHistory();
            if (s === 'analytics') {
                renderBodyWeightChart();
                renderVolumeChart();
                renderDeloadSuggestion();
            }
            if (s === 'analytics') {
    renderBodyWeightChart();
    renderVolumeChart();
    renderDeloadSuggestion();
    document.getElementById('muscle-volume-section').innerHTML = renderMuscleVolume(); 
}
        }

        function addCustomExercise() {
            const input = document.getElementById('custom-exercise');
            const name = input.value.trim();
            if (name && !customExercises.includes(name)) {
                customExercises.push(name);
                try { localStorage.setItem('zerolog_custom_exercises', JSON.stringify(customExercises)); } catch (e) {}
                input.value = '';
                renderCustomExercises();
                renderQuickSelect();
            }
        }

        function removeCustomExercise(name) {
            customExercises = customExercises.filter(ex => ex !== name);
            try { localStorage.setItem('zerolog_custom_exercises', JSON.stringify(customExercises)); } catch (e) {}
            renderCustomExercises();
            renderQuickSelect();
        }

        function renderCustomExercises() {
            const container = document.getElementById('custom-exercises-list');
            if (customExercises.length === 0) {
                container.innerHTML = '<div style="color: var(--dim); font-size: 12px;">No custom exercises yet</div>';
                return;
            }
            container.innerHTML = customExercises.map(ex => 
                `<div class="q-btn" style="display: flex; align-items: center; gap: 8px;">${ex}<span onclick="removeCustomExercise('${ex.replace(/'/g, "\\'")}')" style="color: #ff4444; cursor: pointer;">√ó</span></div>`
            ).join('');
        }

        function renderQuickSelect() {
            const allExercises = [...new Set([...quickExList, ...customExercises])];
            document.getElementById('quickSelect').innerHTML = allExercises.map(ex => 
                `<div class="q-btn" onclick="addExercise('${ex.replace(/'/g, "\\'")}')">${ex}</div>`
            ).join('');
            document.getElementById('exercise-search').style.display = (allExercises.length > 10) ? 'block' : 'none';
        }

        function filterQuickSelect() {
            const searchTerm = document.getElementById('exercise-search').value.toLowerCase();
            const allExercises = [...new Set([...quickExList, ...customExercises])];
            const filtered = allExercises.filter(ex => ex.toLowerCase().includes(searchTerm));
            document.getElementById('quickSelect').innerHTML = filtered.map(ex => 
                `<div class="q-btn" onclick="addExercise('${ex.replace(/'/g, "\\'")}')">${ex}</div>`
            ).join('');
        }

        function addExercise(name) {
            const exName = name || document.getElementById('new-ex-name').value.trim();
            if (exName) {
                workouts.push({ 
                    id: Date.now(), 
                    day: currentDay, 
                    name: exName, 
                    sets: [], 
                    feeling: '',
                    order: workouts.filter(w => w.day === currentDay).length
                });
                document.getElementById('new-ex-name').value = ''; 
                save();
                startWorkoutTimer();
            }
        }

        function deleteExercise(exId, exName) {
            if(confirm(`Delete "${exName}" and all its sets?`)) {
                workouts = workouts.filter(w => w.id !== exId);
                save();
            }
        }

        function addSet(exId) {
            const wInput = document.getElementById(`w-${exId}`);
            const rInput = document.getElementById(`r-${exId}`);
            const w = wInput.value.trim(); 
            const r = rInput.value.trim();
            
            wInput.classList.remove('input-error'); 
            rInput.classList.remove('input-error');
            
            if(!w || !r) {
                if(!w) wInput.classList.add('input-error');
                if(!r) rInput.classList.add('input-error');
                return;
            }
            
            const weight = parseFloat(w); 
            const reps = parseInt(r);
            
            if(isNaN(weight) || weight <= 0 || isNaN(reps) || reps <= 0) {
                if(isNaN(weight) || weight <= 0) wInput.classList.add('input-error');
                if(isNaN(reps) || reps <= 0) rInput.classList.add('input-error');
                return;
            }

            const workout = workouts.find(w => w.id === exId);
            const setType = document.querySelector(`input[name="type-${exId}"]:checked`)?.value || 'working';
            const note = document.getElementById(`note-${exId}`)?.value || '';

            workout.sets.push({
                weight: weight, 
                reps: reps, 
                type: setType, 
                note: note
            });
            
            checkForPR(workout.name, weight);
            lastSetTime[exId] = Date.now();

            save(); 
            showSuccessIndicator();
            
            if (autoStartTimer) startTimer(defaultTimer);
            
            wInput.value = weight; 
            rInput.value = reps;
            if (note) document.getElementById(`note-${exId}`).value = '';
            wInput.focus();
        }

        function completeWorkout() {
            const dailyEx = workouts.filter(ex => ex.day === currentDay);
            const completedExercises = dailyEx.filter(ex => ex.sets.length > 0);
if(completedExercises.length === 0) { 
            alert('Add some sets before completing your workout!'); 
            return; 
        }
        
        stopWorkoutTimer();
        
        confetti({ 
            particleCount: 150, 
            spread: 70, 
            origin: {y: 0.6}, 
            colors: ['#2563eb', '#ffffff'] 
        });
        
        // Save workout notes
        const notes = document.getElementById('workout-notes').value.trim();
        if (notes) {
            workoutNotes[new Date().toISOString()] = notes;
            try {
                localStorage.setItem('zerolog_workout_notes', JSON.stringify(workoutNotes));
            } catch(e) {}
        }
        
        history.push({ 
            date: new Date().toISOString(), 
            label: dayLabels[currentDay] || currentDay, 
            exercises: completedExercises,
            notes: notes || ''
        });
        
        try { 
            localStorage.setItem('zerolog_history', JSON.stringify(history)); 
        } catch(e) { 
            alert('Warning: Could not save workout history.'); 
        }
        
        const completedIds = completedExercises.map(ex => ex.id);
        workouts = workouts.map(ex => { 
            if(completedIds.includes(ex.id)) { 
                return {...ex, sets: [], feeling: ''}; 
            } 
            return ex; 
        });
        
        calculateStreak();
        save(); 
        document.getElementById('workout-notes').value = '';
        alert('Workout logged!');
    }

    function deleteSet(exId, index) {
        const workout = workouts.find(w => w.id === exId);
        const deletedSet = workout.sets[index];
        undoStack = [{type: 'set', exId: exId, index: index, set: deletedSet}];
        workout.sets.splice(index, 1);
        save();
        showUndoBanner('Set deleted');
    }

    function undoDelete() {
        if(undoStack.length === 0) return;
        const action = undoStack.pop();
        if(action.type === 'set') {
            const workout = workouts.find(w => w.id === action.exId);
            if(workout) {
                workout.sets.splice(action.index, 0, action.set);
                save();
            }
        }
        hideUndoBanner();
    }

    function showUndoBanner(m) {
        const b = document.getElementById('undo-banner');
        document.getElementById('undo-message').textContent = m;
        b.style.display = 'flex';
        setTimeout(() => { hideUndoBanner(); }, 5000);
    }

    function hideUndoBanner() {
        document.getElementById('undo-banner').style.display = 'none';
    }

    function updateFeeling(exId, val) {
        workouts.find(w => w.id === exId).feeling = val;
        save();
    }

    function repeatLastWorkout() {
        const lastWorkout = getLastWorkoutForDay(currentDay);
        if(lastWorkout && confirm('Load exercises from your last ' + currentDay + ' workout?')) {
            lastWorkout.exercises.forEach(ex => {
                workouts.push({
                    id: Date.now() + Math.random(),
                    day: currentDay,
                    name: ex.name,
                    sets: [],
                    feeling: ''
                });
            });
            save();
        }
    }

    function getLastWorkoutForDay(day) {
        const dayWorkouts = history.filter(h => {
            const date = new Date(h.date);
            const workoutDay = date.toLocaleDateString('en-US', {weekday: 'short'});
            return workoutDay === day;
        });
        return dayWorkouts.length > 0 ? dayWorkouts[dayWorkouts.length - 1] : null;
    }

    function toggleRestDay() {
        if(restDays.includes(currentDay)) {
            restDays = restDays.filter(d => d !== currentDay);
        } else {
            restDays.push(currentDay);
            stopWorkoutTimer();
        }
        try {
            localStorage.setItem('zerolog_rest_days', JSON.stringify(restDays));
        } catch(e) {}
        render();
    }

    function saveTimerSettings() {
        const value = parseInt(document.getElementById('default-timer').value);
        if(value >= 30 && value <= 300) {
            defaultTimer = value;
            try {
                localStorage.setItem('zerolog_default_timer', defaultTimer);
            } catch(e) {}
            alert('Timer settings saved!');
        } else {
            alert('Please enter a value between 30 and 300 seconds');
        }
    }

    // IMPROVED TIMER FUNCTIONS - Replace existing timer functions with these

function startTimer(seconds) {
    clearInterval(timerInterval);
    const banner = document.getElementById('timer-banner');
    banner.style.display = 'flex';
    banner.style.background = 'var(--accent)';
    
    const adContainer = document.getElementById('timer-ad-container');
    if(typeof adsbygoogle !== 'undefined') {
        try {
            adContainer.innerHTML = '<ins class="adsbygoogle" style="display:inline-block;width:320px;height:50px" data-ad-client="ca-pub-9180492943097575" data-ad-slot="6115261796"></ins>';
            (adsbygoogle = window.adsbygoogle || []).push({});
        } catch(e) {}
    }
    
    let remaining = seconds;
    updateTimerDisplay(remaining);
    
    timerInterval = setInterval(() => {
        remaining--;
        updateTimerDisplay(remaining);
        
        // Audio countdown beeps
        if(remaining === 10) {
            playBeep(600, 0.15); // 10 second warning
        }
        if(remaining <= 5 && remaining > 0) {
            playBeep(800, 0.2); // Countdown beeps
            if(navigator.vibrate) navigator.vibrate(50);
        }
        if(remaining === 0) {
            playBeep(1000, 0.5, 3); // Triple beep finish
            if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
            setTimeout(() => stopTimer(), 2000);
        }
    }, 1000);
}

function playBeep(frequency = 800, duration = 0.2, count = 1) {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        for(let i = 0; i < count; i++) {
            setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + (i * 0.15);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }, i * 150);
        }
    } catch(e) {
        console.log('Audio not supported');
    }
}

function updateTimerDisplay(remaining) {
    let m = Math.floor(remaining / 60);
    let s = remaining % 60;
    const display = `${m}:${s < 10 ? '0' : ''}${s}`;
    document.getElementById('timer-display').innerText = display;
    
    // Visual feedback for final countdown
    const banner = document.getElementById('timer-banner');
    if(remaining <= 5 && remaining > 0) {
        banner.style.background = '#ef4444';
    } else if(remaining <= 10 && remaining > 5) {
        banner.style.background = '#f59e0b';
    } else {
        banner.style.background = 'var(--accent)';
    }
    
    document.title = remaining > 0 ? `(${display}) ZeroLog` : 'ZeroLog';
}

function stopTimer() {
    clearInterval(timerInterval);
    document.getElementById('timer-banner').style.display = 'none';
    document.title = 'ZeroLog';
}

    function playTimerSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch(e) {}
    }

    function suggestNextWeight(n) {
        const r = history.filter(h => h.exercises.some(e => e.name === n)).slice(-4);
        if(r.length < 2) return null;
        
        const l = r[r.length - 1];
        const e = l.exercises.find(e => e.name === n);
        if(!e || e.sets.length === 0) return null;
        
        const a = e.sets.reduce((s, set) => s + parseFloat(set.weight), 0) / e.sets.length;
        const v = e.sets.reduce((s, set) => s + parseInt(set.reps), 0) / e.sets.length;
        
        let p = 1.025, c = 0.7, reason = '';
        
        if(v > 10 && e.feeling === 'Easy') {
            p = 1.075; c = 0.9;
            reason = 'High reps and felt easy - time to go heavier üí™';
        } else if(v > 8 && e.feeling !== 'Brutal') {
            p = 1.05; c = 0.85;
            reason = 'Strong rep count - bump the weight up üìà';
        } else if(v < 5 && e.feeling === 'Brutal') {
            p = 0.95; c = 0.8;
            reason = 'Tough session with low reps - maybe dial it back a bit üßò';
        } else if(e.feeling === 'Easy') {
            p = 1.05; c = 0.85;
            reason = 'Felt easy - ready for more weight üí™';
        } else if(e.feeling === 'Solid') {
            p = 1.025; c = 0.75;
            reason = 'Solid work - keep progressing steadily üìä';
        } else if(e.feeling === 'Brutal') {
            p = 1.0; c = 0.7;
            reason = 'That was rough - stay here or drop slightly üéØ';
        } else {
            reason = 'Keep building steadily üìà';
        }
        
        const suggested = Math.round(a * p * 2) / 2;
        return {weight: suggested, confidence: c, reason: reason, lastWeight: a};
    }

    function calculateFatigueScore() {
        const l = history.filter(h => {
            const d = new Date(h.date);
            const t = new Date();
            t.setDate(t.getDate() - 14);
            return d > t;
        });
        
        if(l.length < 3) return null;
        
        let f = 0, b = 0, t = 0, s = 0;
        l.forEach(w => {
            w.exercises.forEach(e => {
                t++;
                s += e.sets.length;
                if(e.feeling === 'Brutal') b++;
                if(e.feeling === 'Easy') f -= 5;
            });
        });
        
        const r = b / t;
        f += r * 100;
        
        const a = s / l.length;
        if(a > 25) f += 20;
        
        const w = l.length / 2;
        if(w > 6) f += 15;
        
        return {
            score: Math.min(Math.max(f, 0), 100),
            recommendation: getFatigueRecommendation(f)
        };
    }

    function getFatigueRecommendation(s) {
        if(s > 70) return {
            type: 'deload',
            message: '‚ö†Ô∏è High fatigue detected. Consider a deload week: drop weight 20-30% or take extra rest',
            color: '#ef4444'
        };
        if(s > 50) return {
            type: 'caution',
            message: 'üü° Fatigue building up. Maybe add a rest day or cut back volume a bit',
            color: '#f59e0b'
        };
        if(s < 20) return {
            type: 'excellent',
            message: '‚úÖ Excellent recovery! Body is adapting well',
            color: '#16a34a'
        };
        return {
            type: 'good',
            message: '‚úÖ Recovery looks good! Keep at it',
            color: '#16a34a'
        };
    }

    function suggestBalancedWorkout() {
        const t = history.filter(h => {
            const d = new Date(h.date);
            const w = new Date();
            w.setDate(w.getDate() - w.getDay());
            return d >= w;
        });
        
        if(t.length === 0) return null;
        
        const trained = new Set();
        t.forEach(w => {
            w.exercises.forEach(ex => {
                for(let [g, e] of Object.entries(muscleGroups)) {
                    if(e.some(e => ex.name.includes(e) || e.includes(ex.name))) {
                        trained.add(g);
                    }
                }
            });
        });
        
        const s = [];
        if(!trained.has('push')) s.push('Chest/Shoulders (Push)');
        if(!trained.has('pull')) s.push('Back (Pull)');
        if(!trained.has('legs')) s.push('Legs');
        
        if(s.length > 0) {
            return {
                type: 'balance',
                message: `üí° Haven't hit these this week: ${s.join(', ')}. Maybe add them in for balance.`
            };
        }
        
        return {
            type: 'balanced',
            message: '‚úÖ Balanced training this week! All major muscle groups covered.'
        };
    }

    function suggestWeeklyProgramming() {
        const l = history.filter(h => {
            const d = new Date(h.date);
            const f = new Date();
            f.setDate(f.getDate() - 28);
            return d > f;
        });
        
        if(l.length < 6) return null;
        
        const v = [];
        for(let i = 0; i < 4; i++) {
            const s = new Date();
            s.setDate(s.getDate() - (7 * (i + 1)));
            const e = new Date();
            e.setDate(e.getDate() - (7 * i));
            
            const w = l.filter(h => {
                const d = new Date(h.date);
                return d >= s && d < e;
            });
            
            const t = w.reduce((sum, w) => {
                return sum + w.exercises.reduce((exSum, ex) => {
                    return exSum + ex.sets.reduce((setSum, s) => {
                        return setSum + (parseFloat(s.weight) * parseInt(s.reps));
                    }, 0);
                }, 0);
            }, 0);
            
            v.unshift(t);
        }
        
        const inc = v[3] > v[0] * 1.2;
        const stag = Math.abs(v[3] - v[0]) < v[0] * 0.1;
        
        if(inc) {
            return {
                type: 'progressive',
                message: 'üìà Nice volume progression! Keep this up for 1-2 more weeks, then plan a deload.',
                suggestion: 'Continue current programming'
            };
        }
        
        if(stag) {
            return {
                type: 'plateau',
                message: 'üìä Volume has plateaued. Try adding a set per exercise OR bump weight by 2.5kg.',
                suggestion: 'Need more stimulus'
            };
        }
        
        return {
            type: 'normal',
            message: '‚úÖ Healthy progression',
            suggestion: 'Keep doing what you\'re doing'
        };
    }

    function renderAIInsights() {
        const d = workouts.filter(ex => ex.day === currentDay);
        if(d.length === 0 || history.length < 3) return '';
        
        const f = calculateFatigueScore();
        const p = suggestWeeklyProgramming();
        const b = suggestBalancedWorkout();
        
        let ins = '<div class="exercise-card ai-insights"><div style="display:flex;align-items:center;gap:8px;margin-bottom:15px;"><span style="font-size:20px;">ü§ñ</span><h3 style="margin:0;color:var(--accent);">Training Insights</h3></div>';
        
        if(f) {
            ins += `<div class="insight-box" style="border-left:3px solid ${f.recommendation.color};"><div class="insight-box-header">Recovery Status (${Math.round(f.score)}/100)</div><div class="insight-box-content">${f.recommendation.message}</div></div>`;
        }
        
        let has = false;
        d.forEach(ex => {
            const sug = suggestNextWeight(ex.name);
            if(sug && sug.confidence > 0.6) {
                if(!has) {
                    ins += '<div class="insight-box"><div class="insight-box-header">Suggestions for Today</div>';
                    has = true;
                }
                ins += `<div class="insight-suggestion"><strong>${ex.name}</strong><br>Last time: ${sug.lastWeight}kg ‚Üí Try: <strong>${sug.weight}kg</strong><br><span style="font-size:11px;">${sug.reason}</span></div>`;
            }
        });
        if(has) ins += '</div>';
        
        if(p) {
            ins += `<div class="insight-box"><div class="insight-box-header">Volume Trends</div><div class="insight-box-content">${p.message}</div></div>`;
        }
        
        if(b) {
            ins += `<div class="insight-box"><div class="insight-box-header">Muscle Balance</div><div class="insight-box-content">${b.message}</div></div>`;
        }
        
        ins += `<div style="font-size:11px;color:#666;text-align:center;margin-top:10px;">Based on your last 4 weeks</div></div>`;
        return ins;
    }

    function calcORM() {
        const w = parseFloat(document.getElementById('orm-weight').value);
        const r = parseInt(document.getElementById('orm-reps').value);
        const res = document.getElementById('orm-result');
        
        if(!w || !r || r < 1) {
            res.innerText = 'Enter valid values';
            return;
        }
        
        const orm = w * (1 + r / 30);
        res.innerText = `${orm.toFixed(1)} kg`;
    }

    function renderHistory() {
        const a = document.getElementById('historyArea');
        document.getElementById('total-workouts').innerText = history.length;
        
        const tv = history.reduce((sum, w) => {
            return sum + w.exercises.reduce((exSum, ex) => {
                return exSum + ex.sets.reduce((setSum, s) => {
                    return setSum + (parseFloat(s.weight) * parseInt(s.reps));
                }, 0);
            }, 0);
        }, 0);
        
        document.getElementById('total-volume').innerText = Math.round(tv).toLocaleString();
        
        if(history.length === 0) {
            a.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>No workout history yet</h3><p>Complete your first workout to see it here!</p></div>';
            return;
        }
        
        const sorted = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        a.innerHTML = sorted.map(w => {
            const d = new Date(w.date);
            const ds = d.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'});
            
            return `<div class="history-item">
                <div class="history-date">${ds} ${w.label ? '- ' + w.label : ''}</div>
                ${w.notes ? `<div style="font-size:12px; color:var(--dim); margin-bottom:10px; font-style:italic;">üí¨ ${w.notes}</div>` : ''}
                ${w.exercises.map(ex => {
                    const vol = ex.sets.reduce((sum, set) => sum + (parseFloat(set.weight) * parseInt(set.reps)), 0);
                    const pr = checkIfPR(ex.name, ex.sets, w.date);
                    
                    return `<div class="history-exercise">
                        <div class="history-exercise-name">${ex.name}${pr ? '<span class="pr-badge">PR</span>' : ''}</div>
                        <div class="history-sets">${ex.sets.map((s, i) => `${s.weight}kg √ó ${s.reps}`).join(' ‚Ä¢ ')}${vol > 0 ? ` ‚Ä¢ Volume: ${vol.toFixed(0)}kg` : ''}</div>
                        ${ex.feeling ? `<div class="history-sets">Felt: ${ex.feeling}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>`;
        }).join('');
    }

    function checkIfPR(n, sets, cd) {
        const mx = Math.max(...sets.map(s => parseFloat(s.weight)));
        const pw = history.filter(h => new Date(h.date) < new Date(cd));
        
        for(let w of pw) {
            for(let ex of w.exercises) {
                if(ex.name === n) {
                    const pm = Math.max(...ex.sets.map(s => parseFloat(s.weight)));
                    if(pm >= mx) return false;
                }
            }
        }
        
        return pw.some(w => w.exercises.some(e => e.name === n));
    }

    function showSuccessIndicator() {
        const i = document.getElementById('success-indicator');
        i.style.display = 'block';
        setTimeout(() => { i.style.display = 'none'; }, 1500);
    }

    function save() {
        try {
            localStorage.setItem('zerolog_data', JSON.stringify(workouts));
        } catch(e) {}
        render();
    }

    function resetData() {
        if(confirm("ZeroLog: Wipe all data? This cannot be undone!")) {
            try {
                localStorage.clear();
                location.reload();
            } catch(e) {}
        }
    }

    function exportData() {
        try {
            const t = new Date().toISOString().split('T')[0];
            const d = {
                workouts,
                history,
                restDays,
                dayLabels,
                customExercises,
                defaultTimer,
                autoStartTimer,
                templates,
                volumeTargets,
                exerciseNotes,
                bodyWeightLog,
                workoutNotes,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };
            
            const b = new Blob([JSON.stringify(d, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `zerolog_export_${t}.json`;
            a.click();
        } catch(e) {
            alert('Error exporting data.');
        }
    }

    function downloadHTML() {
        try {
            const h = document.documentElement.outerHTML;
            const b = new Blob([h], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = 'zerolog.html';
            a.click();
            alert('HTML file downloaded!');
        } catch(e) {
            alert('Error downloading file.');
        }
    }

    function importData(event) {
        const f = event.target.files[0];
        if(!f) return;
        
        const r = new FileReader();
        r.onload = function(e) {
            try {
                const d = JSON.parse(e.target.result);
                
                if(confirm('Import data? This will merge with your current data. Export first if you want to backup!')) {
                    if(d.workouts && Array.isArray(d.workouts)) {
                        const eIds = new Set(workouts.map(w => w.id));
                        const nw = d.workouts.filter(w => !eIds.has(w.id));
                        workouts = [...workouts, ...nw];
                        localStorage.setItem('zerolog_data', JSON.stringify(workouts));
                    }
                    
                    if(d.history && Array.isArray(d.history)) {
                        const eDs = new Set(history.map(h => h.date));
                        const nh = d.history.filter(h => !eDs.has(h.date));
                        history = [...history, ...nh];
                        localStorage.setItem('zerolog_history', JSON.stringify(history));
                    }
                    
                    if(d.restDays && Array.isArray(d.restDays)) {
                        restDays = [...new Set([...restDays, ...d.restDays])];
                        localStorage.setItem('zerolog_rest_days', JSON.stringify(restDays));
                    }
                    
                    if(d.dayLabels) {
                        dayLabels = {...dayLabels, ...d.dayLabels};
                        localStorage.setItem('zerolog_day_labels', JSON.stringify(dayLabels));
                    }
                    
                    if(d.customExercises && Array.isArray(d.customExercises)) {
                        customExercises = [...new Set([...customExercises, ...d.customExercises])];
                        localStorage.setItem('zerolog_custom_exercises', JSON.stringify(customExercises));
                    }
                    
                    if(d.defaultTimer) {
                        defaultTimer = d.defaultTimer;
                        localStorage.setItem('zerolog_default_timer', defaultTimer);
                    }
                    
                    if(d.autoStartTimer !== undefined) {
                        autoStartTimer = d.autoStartTimer;
                        localStorage.setItem('zerolog_auto_start_timer', JSON.stringify(autoStartTimer));
                    }
                    
                    if(d.templates) {
                        templates = [...templates, ...d.templates];
                        localStorage.setItem('zerolog_templates', JSON.stringify(templates));
                    }
                    
                    if(d.exerciseNotes) {
                        exerciseNotes = {...exerciseNotes, ...d.exerciseNotes};
                        localStorage.setItem('zerolog_exercise_notes', JSON.stringify(exerciseNotes));
                    }
                    
                    if(d.bodyWeightLog) {
                        bodyWeightLog = [...bodyWeightLog, ...d.bodyWeightLog];
                        localStorage.setItem('zerolog_bodyweight', JSON.stringify(bodyWeightLog));
                    }
                    
                    alert('Data imported successfully!');
                    init();
                }
            } catch(e) {
                alert('Error importing data.');
            }
        };
        
        r.readAsText(f);
        event.target.value = '';
    }

    function loadExerciseDatabase() {
        exerciseDatabase = [
            {name: 'Bench Press', muscle: 'chest', equipment: 'barbell'},
            {name: 'Incline Bench Press', muscle: 'chest', equipment: 'barbell'},
            {name: 'Decline Bench Press', muscle: 'chest', equipment: 'barbell'},
            {name: 'Dumbbell Bench Press', muscle: 'chest', equipment: 'dumbbell'},
            {name: 'Incline Dumbbell Press', muscle: 'chest', equipment: 'dumbbell'},
            {name: 'Dumbbell Fly', muscle: 'chest', equipment: 'dumbbell'},
            {name: 'Cable Fly', muscle: 'chest', equipment: 'cable'},
            {name: 'Push Up', muscle: 'chest', equipment: 'bodyweight'},
            {name: 'Dips', muscle: 'chest', equipment: 'bodyweight'},
            {name: 'Deadlift', muscle: 'back', equipment: 'barbell'},
            {name: 'Romanian Deadlift', muscle: 'back', equipment: 'barbell'},
            {name: 'Barbell Row', muscle: 'back', equipment: 'barbell'},
            {name: 'T-Bar Row', muscle: 'back', equipment: 'barbell'},
            {name: 'Lat Pulldown', muscle: 'back', equipment: 'cable'},
            {name: 'Pull Up', muscle: 'back', equipment: 'bodyweight'},
            {name: 'Chin Up', muscle: 'back', equipment: 'bodyweight'},
            {name: 'Cable Row', muscle: 'back', equipment: 'cable'},
            {name: 'Face Pull', muscle: 'back', equipment: 'cable'},
            {name: 'Dumbbell Row', muscle: 'back', equipment: 'dumbbell'},
            {name: 'Seal Row', muscle: 'back', equipment: 'barbell'},
            {name: 'Squat', muscle: 'legs', equipment: 'barbell'},
            {name: 'Front Squat', muscle: 'legs', equipment: 'barbell'},
            {name: 'Leg Press', muscle: 'legs', equipment: 'machine'},
            {name: 'Lunges', muscle: 'legs', equipment: 'dumbbell'},
            {name: 'Bulgarian Split Squat', muscle: 'legs', equipment: 'dumbbell'},
            {name: 'Leg Curl', muscle: 'legs', equipment: 'machine'},
            {name: 'Leg Extension', muscle: 'legs', equipment: 'machine'},
            {name: 'Hack Squat', muscle: 'legs', equipment: 'machine'},
            {name: 'Walking Lunges', muscle: 'legs', equipment: 'dumbbell'},
            {name: 'Goblet Squat', muscle: 'legs', equipment: 'dumbbell'},
            {name: 'Calf Raise', muscle: 'legs', equipment: 'machine'},
            {name: 'Shoulder Press', muscle: 'shoulders', equipment: 'barbell'},
            {name: 'Overhead Press', muscle: 'shoulders', equipment: 'barbell'},
            {name: 'Dumbbell Shoulder Press', muscle: 'shoulders', equipment: 'dumbbell'},
            {name: 'Lateral Raise', muscle: 'shoulders', equipment: 'dumbbell'},
            {name: 'Front Raise', muscle: 'shoulders', equipment: 'dumbbell'},
            {name: 'Rear Delt Fly', muscle: 'shoulders', equipment: 'dumbbell'},
            {name: 'Arnold Press', muscle: 'shoulders', equipment: 'dumbbell'},
            {name: 'Cable Lateral Raise', muscle: 'shoulders', equipment: 'cable'},
            {name: 'Upright Row', muscle: 'shoulders', equipment: 'barbell'},
            {name: 'Bicep Curl', muscle: 'arms', equipment: 'dumbbell'},
            {name: 'Hammer Curl', muscle: 'arms', equipment: 'dumbbell'},
            {name: 'Preacher Curl', muscle: 'arms', equipment: 'barbell'},
            {name: 'Cable Curl', muscle: 'arms', equipment: 'cable'},
            {name: 'Concentration Curl', muscle: 'arms', equipment: 'dumbbell'},
            {name: 'Tricep Pushdown', muscle: 'arms', equipment: 'cable'},
            {name: 'Tricep Extension', muscle: 'arms', equipment: 'dumbbell'},
            {name: 'Overhead Tricep Extension', muscle: 'arms', equipment: 'dumbbell'},
            {name: 'Skull Crusher', muscle: 'arms', equipment: 'barbell'},
            {name: 'Close Grip Bench Press', muscle: 'arms', equipment: 'barbell'},
            {name: 'Plank', muscle: 'core', equipment: 'bodyweight'},
            {name: 'Crunches', muscle: 'core', equipment: 'bodyweight'},
            {name: 'Cable Crunch', muscle: 'core', equipment: 'cable'},
            {name: 'Hanging Leg Raise', muscle: 'core', equipment: 'bodyweight'},
            {name: 'Ab Wheel', muscle: 'core', equipment: 'bodyweight'},
            {name: 'Russian Twist', muscle: 'core', equipment: 'bodyweight'},
            {name: 'Mountain Climbers', muscle: 'core', equipment: 'bodyweight'}
        ];
        filteredExercises = [...exerciseDatabase];
    }

    function openExerciseLibrary() {
        document.getElementById('exercise-modal').style.display = 'block';
        renderExerciseLibrary();
    }

    function closeExerciseLibrary() {
        document.getElementById('exercise-modal').style.display = 'none';
    }

    function filterExerciseLibrary() {
        const st = document.getElementById('exercise-lib-search').value.toLowerCase();
        const mf = document.getElementById('muscle-filter').value.toLowerCase();
        const ef = document.getElementById('equipment-filter').value.toLowerCase();
        
        filteredExercises = exerciseDatabase.filter(ex => {
            const ms = ex.name.toLowerCase().includes(st);
            const mm = !mf || ex.muscle.toLowerCase().includes(mf);
            const me = !ef || ex.equipment.toLowerCase().includes(ef);
            return ms && mm && me;
        });
        
        renderExerciseLibrary();
    }

    async function searchExercisesFromAPI() {
        const si = document.getElementById('exercise-lib-search').value.trim();
        const c = document.getElementById('exercise-library-list');
        
        if(!si || si.length < 3) {
            alert("Please enter at least 3 characters to search the cloud database.");
            return;
        }
        
        c.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;"><div style="border:4px solid #222;border-top:4px solid var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 10px;"></div><span style="color:var(--dim);font-weight:bold;font-size:12px;letter-spacing:1px;">SEARCHING CLOUD DATABASE...</span></div>`;
        
        const opts = {
            method: 'GET',
            headers: {
                'X-RapidAPI-Key': RAPIDAPI_KEY,
                'X-RapidAPI-Host': 'exercisedb.p.rapidapi.com'
            }
        };
        
        try {
            const res = await fetch(`https://exercisedb.p.rapidapi.com/exercises/name/${si}?limit=20`, opts);
            if(!res.ok) throw new Error('Network response was not ok');
            
            const data = await res.json();
            
            if(data.length === 0) {
                c.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--danger);padding:20px;">No results found in cloud database. Try different keywords.</div>`;
                return;
            }
            
            c.innerHTML = data.map(ex => 
                `<div class="exercise-item" onclick="importFromAPI('${ex.name.replace(/'/g, "\\'")}','${ex.bodyPart}','${ex.equipment}','${ex.gifUrl}')" style="display:flex;gap:10px;align-items:center;padding:12px;">
                    <img src="${ex.gifUrl}" style="width:50px;height:50px;border-radius:6px;background:#222;object-fit:cover;" loading="lazy" onerror="this.style.display='none'">
                    <div style="flex:1;">
                        <div class="exercise-name">${ex.name.charAt(0).toUpperCase() + ex.name.slice(1)}</div>
                        <div class="exercise-meta">${ex.bodyPart} ‚Ä¢ ${ex.equipment}</div>
                        <small style="font-size:10px;color:#666;">Target: ${ex.target}</small>
                    </div>
                </div>`
            ).join('');
        } catch(e) {
            c.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--danger);padding:20px;">API connection failed. Using local database only.</div>`;
            setTimeout(() => { filterExerciseLibrary(); }, 2000);
        }
    }

    function importFromAPI(n, b, e, g) {
        const fn = n.charAt(0).toUpperCase() + n.slice(1);
        addExercise(fn);
        closeExerciseLibrary();
        showSuccessIndicator();
        
        if(!customExercises.includes(fn)) {
            customExercises.push(fn);
            try {
                localStorage.setItem('zerolog_custom_exercises', JSON.stringify(customExercises));
            } catch(e) {}
            renderCustomExercises();
            renderQuickSelect();
        }
    }

    function renderExerciseLibrary() {
        const c = document.getElementById('exercise-library-list');
        
        if(filteredExercises.length === 0) {
            c.innerHTML = '<div class="empty-state"><p>No exercises found</p></div>';
            return;
        }
        
        c.innerHTML = filteredExercises.slice(0, 50).map(ex => 
            `<div class="exercise-item" onclick="addExerciseFromLibrary('${ex.name.replace(/'/g, "\\'")}')">
                <div class="exercise-name">${ex.name}</div>
                <div class="exercise-meta">${ex.muscle} ‚Ä¢ ${ex.equipment}</div>
            </div>`
        ).join('');
        
        if(filteredExercises.length > 50) {
            c.innerHTML += `<div style="text-align:center;padding:20px;color:var(--dim);font-size:12px;">Showing 50 of ${filteredExercises.length} exercises. Use filters to narrow down.</div>`;
        }
        
        const st = document.getElementById('exercise-lib-search').value.trim();
        if(st.length >= 3) {
            c.innerHTML += `<div style="grid-column:1/-1;text-align:center;padding:15px;"><button onclick="searchExercisesFromAPI()" style="background:#16a34a;padding:12px 24px;">üîç Search Cloud Database for "${st}"</button><div style="font-size:10px;color:#666;margin-top:8px;">Find exercises beyond the core library</div></div>`;
        }
    }

    function addExerciseFromLibrary(name) {
        addExercise(name);
        closeExerciseLibrary();
        showSuccessIndicator();
    }

    function render() {
        const a = document.getElementById('workoutArea');
        const isRest = restDays.includes(currentDay);
        const dailyEx = workouts.filter(ex => ex.day === currentDay);
        
        document.getElementById('rest-btn-toggle').innerText = isRest ? "Resume Training" : "Mark as Rest Day";
        document.querySelector('.add-ex-container').style.display = isRest ? 'none' : 'flex';
        document.querySelector('.quick-select').style.display = isRest ? 'none' : 'flex';
        document.querySelector('.day-title-container').style.display = isRest ? 'none' : 'block';
        document.getElementById('complete-btn').style.display = (dailyEx.length > 0 && dailyEx.some(ex => ex.sets.length > 0) && !isRest) ? 'block' : 'none';
        document.getElementById('exercise-search').style.display = isRest ? 'none' : (customExercises.length + quickExList.length > 10 ? 'block' : 'none');
        document.getElementById('workout-notes-section').style.display = isRest ? 'none' : (dailyEx.length > 0 ? 'block' : 'none');
        
        const repeatBtn = document.getElementById('repeat-btn');
        const lastWorkout = getLastWorkoutForDay(currentDay);
        repeatBtn.style.display = (lastWorkout && !isRest && dailyEx.length === 0) ? 'block' : 'none';
        
        renderQuickStats();
        
        if(isRest) {
            a.innerHTML = `<div class="exercise-card" style="text-align:center;">
                <div style="font-size:40px;margin-bottom:10px;">üßò</div>
                <h3>Recovery Mode</h3>
                <div class="recovery-grid">
                    <div class="recovery-tip"><strong>Hydration</strong>2-3L Water</div>
                    <div class="recovery-tip"><strong>Movement</strong>15m Walk</div>
                    <div class="recovery-tip"><strong>Nutrition</strong>High Protein</div>
                    <div class="recovery-tip"><strong>Sleep</strong>8+ Hours</div>
                </div>
            </div>`;
            return;
        }
        
        if(dailyEx.length === 0) {
            a.innerHTML = `<div class="empty-state">
                <div class="empty-state-icon">üí™</div>
                <h3>Ready to train?</h3>
                <p>Add an exercise above or select from quick options to get started.</p>
            </div>`;
            return;
        }

        const aiInsights = renderAIInsights();
        a.innerHTML = aiInsights || '';

        // ADD THIS SECTION:
        a.innerHTML += renderRecentExercises();

        if (workoutStreak > 0) {
    // ... existing streak banner code
}
        if (workoutStreak > 0) {
            a.innerHTML += `<div class="streak-banner">
                <div class="streak-icon">üî•</div>
                <div class="streak-text">
                    <div class="streak-count">${workoutStreak} Day Streak!</div>
                    <div style="font-size:12px;opacity:0.9;">Keep it going!</div>
                </div>
            </div>`;
        }

        if (dailyEx.length > 0) {
            a.innerHTML += `<div class="view-toggle">
                <button class="view-btn ${!compactView ? 'active' : ''}" onclick="if(compactView) toggleCompactView()">Normal View</button>
                <button class="view-btn ${compactView ? 'active' : ''}" onclick="if(!compactView) toggleCompactView()">Compact View</button>
            </div>`;
        }

// Inside render() function, replace the exercise card HTML generation:

a.innerHTML += dailyEx.map(ex => {
    const lastWorkout = getLastWorkoutForExercise(ex.name);
    const volume = calculateExerciseVolume(ex.sets);
    const lastSet = ex.sets.length > 0 ? ex.sets[ex.sets.length - 1] : null;
    const timeSince = getTimeSinceLastSet(ex.id);
    const note = exerciseNotes[ex.name] || '';

    if (compactView && ex.sets.length > 0) {
        const weights = [...new Set(ex.sets.map(s => s.weight))];
        const setsDisplay = weights.map(w => {
            const repsForWeight = ex.sets.filter(s => s.weight == w).map(s => s.reps).join(',');
            return `${w}kg: ${repsForWeight}`;
        }).join(' ‚Ä¢ ');

        return `<div class="exercise-card">
            ${volume > 0 ? `<div class="ex-volume">üìä ${Math.round(volume)}kg</div>` : ''}
            <div class="ex-header">
                <span class="ex-header-left" onclick="showExerciseHistory('${ex.name.replace(/'/g, "\\'")}')">${ex.name}</span>
                <span class="delete-btn" onclick="deleteExercise(${ex.id},'${ex.name.replace(/'/g, "\\'")}');">‚úï</span>
            </div>
            <div class="compact-sets">${setsDisplay}</div>
            ${note ? `<div style="font-size:11px; color:var(--warning); margin-top:5px;">üí° ${note}</div>` : ''}
            <div class="input-row" style="margin-top:10px;">
                <input type="number" id="w-${ex.id}" placeholder="kg" inputmode="decimal" value="${lastSet ? lastSet.weight : ''}" step="0.5" ontouchstart="handleWeightInputTap(${ex.id})">
                <input type="number" id="r-${ex.id}" placeholder="reps" inputmode="numeric" value="${lastSet ? lastSet.reps : ''}" step="1">
                <button onclick="addSet(${ex.id})">‚úì</button>
            </div>
        </div>`;
    }

    return `<div class="exercise-card">
    ${volume > 0 ? `<div class="ex-volume">üìä ${Math.round(volume)}kg</div>` : ''}
    <div class="ex-header">
        <span class="ex-header-left" onclick="showExerciseHistory('${ex.name.replace(/'/g, "\\'")}')">${ex.name}</span>
        <span class="delete-btn" onclick="deleteExercise(${ex.id},'${ex.name.replace(/'/g, "\\'")}');">‚úï</span>
    </div>
    ${getPRDisplay(ex.name)}
    ${note ? `<div style="font-size:11px; color:var(--warning); padding:8px; background:rgba(245, 158, 11, 0.1); border-radius:6px; margin-bottom:10px;">üí° ${note}</div>` : ''}
    ${lastWorkout ? `<div class="last-workout-ref">
        <div class="last-workout-ref-header" onclick="toggleLastWorkoutRef(${ex.id})">
            <span>Last: ${lastWorkout.sets.map(s => `${s.weight}√ó${s.reps}`).join(', ')}</span>
            <span style="color: var(--accent);">‚ñº</span>
        </div>
        <div class="last-workout-ref-content" id="last-workout-${ex.id}">
            ${lastWorkout.sets.map((s, i) => `Set ${i+1}: ${s.weight}kg √ó ${s.reps}`).join(' ‚Ä¢ ')}
        </div>
    </div>` : ''}
    ${ex.sets.map((s, i) => {
        const progress = i === ex.sets.length - 1 && lastWorkout ? getProgressIndicator(ex.name, s.weight, s.reps) : '';
        const typeB = s.type === 'warmup' ? '<span class="set-type-badge warmup-badge">W</span>' : 
                    s.type === 'cluster' ? '<span class="set-type-badge cluster-badge">C</span>' :
                    s.type === 'drop' ? '<span class="set-type-badge drop-badge">D</span>' :
                    s.type === 'amrap' ? '<span class="set-type-badge amrap-badge">A</span>' : '';
        const noteD = s.note ? `<br><span style="font-size:11px; color:var(--dim);">üí¨ ${s.note}</span>` : '';
        
        return `<div class="set-row" ontouchstart="handleSwipeStart(event, ${ex.id}, ${i})" ontouchmove="handleSwipeMove(event, ${ex.id}, ${i})" ontouchend="handleSwipeEnd(event, ${ex.id}, ${i})">
            <span>Set ${i + 1}: ${s.weight}kg √ó ${s.reps}${typeB}${progress}${noteD}</span>
            <span class="delete-btn" onclick="deleteSet(${ex.id},${i})">‚úï</span>
            <div class="set-delete-reveal">DELETE</div>
        </div>`;
    }).join('')}
    ${timeSince ? `<div class="time-since">‚è±Ô∏è ${timeSince}</div>` : ''}
    
    <div class="input-row">
        <input type="number" id="w-${ex.id}" placeholder="kg" inputmode="decimal" value="${lastSet ? lastSet.weight : ''}" step="0.5" ontouchstart="handleWeightInputTap(${ex.id})">
        <input type="number" id="r-${ex.id}" placeholder="reps" inputmode="numeric" value="${lastSet ? lastSet.reps : ''}" step="1" ontouchstart="handleWeightInputTap(${ex.id})">
        <button onclick="addSet(${ex.id})">ADD SET</button>
    </div>
    
    <div class="weight-controls">
        <button class="weight-adjust-btn" onclick="adjustWeight(${ex.id}, -5)">‚àí5</button>
        <button class="weight-adjust-btn" onclick="adjustWeight(${ex.id}, -2.5)">‚àí2.5</button>
        <button class="weight-adjust-btn" onclick="adjustWeight(${ex.id}, 2.5)">+2.5</button>
        <button class="weight-adjust-btn" onclick="adjustWeight(${ex.id}, 5)">+5</button>
    </div>
    
    <div class="set-type-selector">
        <label class="type-btn active">
            <input type="radio" name="type-${ex.id}" value="working" checked style="display:none">
            üí™
        </label>
        <label class="type-btn">
            <input type="radio" name="type-${ex.id}" value="warmup" style="display:none">
            üî•
        </label>
        <label class="type-btn">
            <input type="radio" name="type-${ex.id}" value="cluster" style="display:none">
            üîó
        </label>
        <label class="type-btn">
            <input type="radio" name="type-${ex.id}" value="drop" style="display:none">
            ‚¨áÔ∏è
        </label>
        <label class="type-btn">
            <input type="radio" name="type-${ex.id}" value="amrap" style="display:none">
            üî•
        </label>
    </div>
    
    <input type="text" id="note-${ex.id}" class="note-input" placeholder="üí¨ Quick note...">
    
    <select class="feel-select" onchange="updateFeeling(${ex.id},this.value)">
        <option value="">How did it feel?</option>
        <option value="Easy" ${ex.feeling === 'Easy' ? 'selected' : ''}>Easy (RPE 5-6)</option>
        <option value="Solid" ${ex.feeling === 'Solid' ? 'selected' : ''}>Solid (RPE 7-8)</option>
        <option value="Brutal" ${ex.feeling === 'Brutal' ? 'selected' : ''}>Brutal (RPE 9-10)</option>
    </select>
</div>`;
}).join('');

        setTimeout(() => {
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.onclick = function() {
                    const parent = this.closest('.set-type-selector');
                    parent.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    this.querySelector('input').checked = true;
                };
            });
        }, 100);
    }
// Recent Exercises from History
function getRecentExercises() {
    const recent = history.slice(-10).flatMap(h => h.exercises.map(e => ({
        name: e.name,
        date: h.date,
        sets: e.sets
    })));
    
    const uniqueNames = [...new Set(recent.map(e => e.name))];
    return uniqueNames.slice(0, 6).map(name => {
        const exs = recent.filter(e => e.name === name);
        const lastEx = exs[exs.length - 1];
        return {
            name: name,
            lastWeight: lastEx.sets.length > 0 ? lastEx.sets[0].weight : 0,
            lastReps: lastEx.sets.length > 0 ? lastEx.sets[0].reps : 0
        };
    });
}

function renderRecentExercises() {
    const dailyEx = workouts.filter(ex => ex.day === currentDay);
    if (dailyEx.length > 0 || history.length < 3) return '';
    
    const recent = getRecentExercises();
    if (recent.length === 0) return '';
    
    return `<div class="recent-exercises">
        <div class="recent-exercises-title">Recent Exercises</div>
        <div class="recent-ex-grid">
            ${recent.map(ex => `
                <div class="recent-ex-btn" onclick="addExercise('${ex.name.replace(/'/g, "\\'")}')">
                    <div class="recent-ex-btn-name">${ex.name}</div>
                    <div class="recent-ex-btn-meta">Last: ${ex.lastWeight}kg √ó ${ex.lastReps}</div>
                </div>
            `).join('')}
        </div>
    </div>`;
}

// Personal Records Tracking
let personalRecords = {};

function loadPRs() {
    try {
        personalRecords = JSON.parse(localStorage.getItem('zerolog_prs')) || {};
    } catch(e) {}
}

function updatePR(exName, weight) {
    if (!personalRecords[exName] || parseFloat(weight) > parseFloat(personalRecords[exName])) {
        personalRecords[exName] = parseFloat(weight);
        try {
            localStorage.setItem('zerolog_prs', JSON.stringify(personalRecords));
        } catch(e) {}
        return true;
    }
    return false;
}

function getPRDisplay(exName) {
    if (!personalRecords[exName]) return '';
    return `<div class="pr-display">
        <div class="pr-display-label">üèÜ Personal Record</div>
        <div class="pr-display-value">${personalRecords[exName]}kg</div>
    </div>`;
}

// Muscle Group Volume Tracking
function calculateMuscleVolume() {
    const thisWeek = history.filter(h => {
        const d = new Date(h.date);
        const weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        weekStart.setHours(0, 0, 0, 0);
        return d >= weekStart;
    });
    
    const volumes = {
        push: 0,
        pull: 0,
        legs: 0,
        arms: 0,
        core: 0
    };
    
    thisWeek.forEach(workout => {
        workout.exercises.forEach(ex => {
            const vol = calculateExerciseVolume(ex.sets);
            for (let [group, exercises] of Object.entries(muscleGroups)) {
                if (exercises.some(e => ex.name.toLowerCase().includes(e.toLowerCase()) || e.toLowerCase().includes(ex.name.toLowerCase()))) {
                    volumes[group] = (volumes[group] || 0) + vol;
                    break;
                }
            }
        });
    });
    
    return volumes;
}

function renderMuscleVolume() {
    const volumes = calculateMuscleVolume();
    const maxVol = Math.max(...Object.values(volumes), 1);
    
    return `<div class="muscle-volume-card">
        <h3 style="margin:0 0 15px 0; font-size:14px;">This Week's Volume by Muscle</h3>
        ${Object.entries(volumes).map(([muscle, vol]) => `
            <div class="muscle-volume-item">
                <div style="flex:1;">
                    <div style="font-size:12px; text-transform:capitalize; font-weight:bold;">${muscle}</div>
                    <div class="muscle-volume-bar">
                        <div class="muscle-volume-fill" style="width: ${(vol/maxVol)*100}%"></div>
                    </div>
                </div>
                <div style="color:var(--accent); font-weight:bold; margin-left:10px;">${Math.round(vol)}kg</div>
            </div>
        `).join('')}
    </div>`;
}

    init();
</script>
</body>
</html>
