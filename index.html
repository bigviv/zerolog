<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZeroLog</title>
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c1830;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:rgba(255,255,255,0.10);
      --primary:#3b82f6;
      --primary2:#2563eb;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 18px;
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(0,0,0,0.10);
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      padding:18px;
      padding-bottom:110px;
      -webkit-tap-highlight-color: transparent;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:22px;
      letter-spacing:-0.5px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background:rgba(255,255,255,0.03);
    }
    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    button, input, select, textarea{
      font:inherit;
      color:inherit;
    }
    .icon-btn{
      width:42px;height:42px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: none;
      cursor:pointer;
    }
    .icon-btn:active{transform:scale(0.98)}
    .container{
      display:flex;
      flex-direction:column;
      gap:14px;
      max-width:920px;
      margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row.space{justify-content:space-between}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .title{
      font-size:15px;
      font-weight:700;
      letter-spacing:-0.2px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
    }
    .tabs{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      cursor:pointer;
      background:rgba(255,255,255,0.03);
      font-weight:600;
      font-size:13px;
    }
    .tab.active{
      border-color:rgba(59,130,246,0.55);
      background:rgba(59,130,246,0.15);
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns: 1.2fr 0.8fr;}
    }

    /* workout exercise cards */
    .workout-ex{
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .workout-ex.dragging{opacity:0.55}
    .workout-ex .head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .ex-name{
      font-size:15px;
      font-weight:800;
      letter-spacing:-0.25px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .handle{
      cursor:grab;
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,0.03);
      user-select:none;
    }
    .ex-meta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,0.03);
    }
    .chip.ok{border-color:rgba(34,197,94,0.35); color: #bbf7d0; background:rgba(34,197,94,0.10)}
    .chip.warn{border-color:rgba(245,158,11,0.35); color: #fde68a; background:rgba(245,158,11,0.10)}
    .chip.primary{border-color:rgba(59,130,246,0.35); color: #bfdbfe; background:rgba(59,130,246,0.10)}

    .sets{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .set-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1.1fr 42px;
      gap:8px;
      align-items:center;
    }
    .set-row input, .set-row select{
      width:100%;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:10px;
      outline:none;
    }
    .set-row input:focus, .set-row select:focus{
      border-color:rgba(59,130,246,0.55);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:11px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{background:var(--primary); color:white}
    .btn.ghost{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--border);
      color:var(--text);
    }
    .btn.danger{background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.35); color:#fecaca}
    .btn:active{transform:scale(0.99)}
    .stack{display:flex; gap:10px; flex-wrap:wrap}

    .set-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .set-item{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      touch-action: pan-y; /* allow vertical scrolling */
    }
    .set-item .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .set-item .main{
      font-weight:800;
      letter-spacing:-0.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .set-item .note{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .type-badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,0.02);
      white-space:nowrap;
    }
    .type-badge.working{border-color:rgba(59,130,246,0.35); color:#bfdbfe; background:rgba(59,130,246,0.10)}
    .type-badge.warmup{border-color:rgba(245,158,11,0.35); color:#fde68a; background:rgba(245,158,11,0.10)}
    .type-badge.drop{border-color:rgba(239,68,68,0.35); color:#fecaca; background:rgba(239,68,68,0.10)}
    .type-badge.cluster{border-color:rgba(34,197,94,0.35); color:#bbf7d0; background:rgba(34,197,94,0.10)}
    .type-badge.amrap{border-color:rgba(168,85,247,0.35); color:#e9d5ff; background:rgba(168,85,247,0.10)}

    /* swipe reveal */
    .swipe-actions{
      position:absolute;
      top:0; right:0; bottom:0;
      display:flex;
      align-items:center;
      padding-right:8px;
      gap:8px;
      transform: translateX(110%);
      transition: transform 160ms ease;
      pointer-events:none;
    }
    .set-item.reveal .swipe-actions{
      transform: translateX(0);
      pointer-events:auto;
    }
    .swipe-actions .mini{
      border-radius:12px;
      padding:8px 10px;
      border:1px solid rgba(239,68,68,0.35);
      background:rgba(239,68,68,0.12);
      color:#fecaca;
      font-weight:900;
      font-size:12px;
    }
    .swipe-actions .mini.ghost{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--text);
    }

    /* bottom dock */
    .dock{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.45));
      backdrop-filter: blur(10px);
      display:flex;
      justify-content:center;
      z-index:50;
    }
    [data-theme="light"] .dock{
      background: linear-gradient(180deg, rgba(255,255,255,0.00), rgba(255,255,255,0.75));
    }
    .dock-inner{
      max-width:920px;
      width:100%;
      display:flex;
      gap:10px;
    }
    .dock-inner .btn{flex:1}

    /* modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:100;
    }
    .modal-backdrop.open{display:flex}
    .modal{
      width:min(520px, 100%);
      background:var(--card2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h2{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:-0.25px;
    }
    .modal .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .modal input, .modal select, .modal textarea{
      width:100%;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      border-radius:12px;
      padding:10px;
      outline:none;
    }
    .modal textarea{grid-column:1/-1; min-height:84px; resize:vertical}
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .timer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
    }
    .timer .big{
      font-weight:900;
      font-size:18px;
      letter-spacing:-0.4px;
    }
    .timer .controls{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,0.03);
      padding:12px;
      outline:none;
      min-height:90px;
      resize:vertical;
    }

    .hr{height:1px;background:var(--border);margin:10px 0;border:0}
  </style>

  <script>
    // Service worker register (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</head>

<body>
  <div class="container" id="app"></div>

  <!-- Edit Set Modal -->
  <div class="modal-backdrop" id="editModalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Edit set</h2>
      <div class="form">
        <input id="editWeight" type="number" step="0.5" inputmode="decimal" placeholder="Weight (kg)" />
        <input id="editReps" type="number" step="1" inputmode="numeric" placeholder="Reps" />
        <select id="editType">
          <option value="working">üí™ Working</option>
          <option value="warmup">üü° Warm-up</option>
          <option value="cluster">üîó Cluster</option>
          <option value="drop">‚¨áÔ∏è Drop</option>
          <option value="amrap">‚ôæÔ∏è AMRAP</option>
        </select>
        <input id="editRest" type="number" step="5" inputmode="numeric" placeholder="Rest (sec)" />
        <textarea id="editNote" placeholder="Set note (optional)"></textarea>
      </div>
      <div class="actions">
        <button class="btn ghost" id="editCancel">Cancel</button>
        <button class="btn danger" id="editDelete">Delete</button>
        <button class="btn primary" id="editSave">Save</button>
      </div>
    </div>
  </div>

  <div class="dock">
    <div class="dock-inner">
      <button class="btn ghost" id="dockPrev">‚óÄ</button>
      <button class="btn primary" id="dockToday">Today</button>
      <button class="btn ghost" id="dockNext">‚ñ∂</button>
    </div>
  </div>

<script>
(function(){
  // ---------------------------
  // Storage keys & helpers
  // ---------------------------
  const LS = {
    theme: 'zerolog_theme',
    program: 'zerolog_program_v2',
    history: 'zerolog_history_v2',
    notes: 'zerolog_notes_v2',
    rest: 'zerolog_rest_dates_v2',
    settings: 'zerolog_settings_v2'
  };

  const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const DAY_TO_INDEX = {Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};

  const todayISO = () => new Date().toISOString().slice(0,10);
  const niceDate = (iso) => {
    const d = new Date(iso + 'T00:00:00');
    return d.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short' });
  };
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function loadJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if(!v) return fallback;
      return JSON.parse(v);
    }catch{ return fallback; }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // ---------------------------
  // Default data
  // ---------------------------
  const defaultProgram = {
    Mon: [
      { id: uid(), name: 'Bench Press', defaults:{rest:120, step:2.5} },
      { id: uid(), name: 'Incline Dumbbell Press', defaults:{rest:90, step:2.0} },
      { id: uid(), name: 'Triceps Pushdown', defaults:{rest:60, step:2.5} }
    ],
    Tue: [
      { id: uid(), name: 'Squat', defaults:{rest:150, step:2.5} },
      { id: uid(), name: 'Leg Press', defaults:{rest:120, step:5} },
      { id: uid(), name: 'Calf Raises', defaults:{rest:60, step:5} }
    ],
    Wed: [
      { id: uid(), name: 'Pull-up / Lat', defaults:{rest:120, step:2.5} },
      { id: uid(), name: 'Seated Row', defaults:{rest:90, step:5} },
      { id: uid(), name: 'Biceps Curl', defaults:{rest:60, step:2.0} }
    ],
    Thu: [
      { id: uid(), name: 'Overhead Press', defaults:{rest:120, step:2.5} },
      { id: uid(), name: 'Lateral Raises', defaults:{rest:60, step:1.0} }
    ],
    Fri: [
      { id: uid(), name: 'Deadlift / RDL', defaults:{rest:180, step:2.5} },
      { id: uid(), name: 'Hamstring Curl', defaults:{rest:75, step:5} }
    ],
    Sat: [],
    Sun: []
  };

  const defaultSettings = {
    autoStartTimer: true,
    beepEnabled: true
  };

  function uid(){
    return String(Date.now() + Math.random());
  }

  // ---------------------------
  // App state
  // ---------------------------
  let theme = localStorage.getItem(LS.theme) || 'dark';
  document.documentElement.setAttribute('data-theme', theme);

  let program = loadJSON(LS.program, defaultProgram);
  let history = loadJSON(LS.history, []); // [{date:'YYYY-MM-DD', day:'Mon', exercises:[{name, sets:[...]}]}]
  let notesByDate = loadJSON(LS.notes, {}); // { 'YYYY-MM-DD': 'text' }
  let restDates = loadJSON(LS.rest, {}); // { 'YYYY-MM-DD': true }
  let settings = loadJSON(LS.settings, defaultSettings);

  // Current date navigator
  let currentDate = todayISO();

  // Timer state
  let timerInterval = null;
  let timerEndsAt = null;
  let timerSeconds = 0;

  // Edit modal state
  let editContext = null; // {date, exName, setId}

  // Render caches
  let cacheLastByExercise = new Map();
  let cachePRByExercise = new Map();

  // ---------------------------
  // Derived helpers
  // ---------------------------
  function dayFromDate(iso){
    const d = new Date(iso + 'T00:00:00');
    const idx = d.getDay(); // 0 Sun .. 6 Sat
    const map = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    return map[idx];
  }

  function getWorkoutForDate(iso){
    const entry = history.find(h => h.date === iso);
    if(entry) return entry;

    // Create from program template
    const day = dayFromDate(iso);
    const template = (program[day] || []).map(ex => ({
      id: ex.id || uid(),
      name: ex.name,
      defaults: ex.defaults || {rest:90, step:2.5},
      sets: []
    }));
    return { date: iso, day, exercises: template };
  }

  function upsertWorkout(workout){
    const idx = history.findIndex(h => h.date === workout.date);
    if(idx >= 0) history[idx] = workout;
    else history.push(workout);
    history.sort((a,b)=> a.date.localeCompare(b.date));
    saveJSON(LS.history, history);
  }

  function rebuildCaches(){
    cacheLastByExercise = new Map();
    cachePRByExercise = new Map();

    // walk history from newest to oldest
    const sorted = [...history].sort((a,b)=> b.date.localeCompare(a.date));

    for(const w of sorted){
      if(!w.exercises) continue;
      for(const ex of w.exercises){
        const name = ex.name;
        if(!cacheLastByExercise.has(name) && ex.sets && ex.sets.length){
          cacheLastByExercise.set(name, {date:w.date, sets: ex.sets});
        }

        // PR logic: max weight, tie-break by reps
        if(ex.sets && ex.sets.length){
          for(const s of ex.sets){
            if(!isFinite(Number(s.weight))) continue;
            const curr = cachePRByExercise.get(name);
            const candidate = { weight:Number(s.weight), reps:Number(s.reps||0), date:w.date };
            if(!curr){
              cachePRByExercise.set(name, candidate);
            }else{
              if(candidate.weight > curr.weight) cachePRByExercise.set(name, candidate);
              else if(candidate.weight === curr.weight && candidate.reps > curr.reps) cachePRByExercise.set(name, candidate);
            }
          }
        }
      }
    }
  }

  function suggestNextWeight(exName, defaults){
    const last = cacheLastByExercise.get(exName);
    if(!last) return '';
    // simplest: take last working set weight, add step
    const step = Number(defaults?.step || 2.5);
    const lastWorking = [...last.sets].reverse().find(s => s.type === 'working' && isFinite(Number(s.weight)));
    if(!lastWorking) return '';
    const next = Number(lastWorking.weight) + step;
    return String(next);
  }

  function getPRText(exName){
    const pr = cachePRByExercise.get(exName);
    if(!pr) return '';
    const repsTxt = pr.reps ? `√ó${pr.reps}` : '';
    return `PR: ${pr.weight}kg${repsTxt} on ${niceDate(pr.date)}`;
  }

  // ---------------------------
  // Timer
  // ---------------------------
  function formatTime(seconds){
    const s = clamp(Math.floor(seconds), 0, 60*60*24);
    const m = Math.floor(s/60);
    const r = s % 60;
    return `${m}:${String(r).padStart(2,'0')}`;
  }

  function playBeep(times = 2){
    if(!settings.beepEnabled) return;
    try{
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioContext();
      const now = ctx.currentTime;

      for(let i=0;i<times;i++){
        const t = now + (i * 0.18);
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, t);
        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.18, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + 0.14);
      }
      setTimeout(()=>ctx.close().catch(()=>{}), 900);
    }catch{
      // ignore
    }
  }

  function startTimer(seconds){
    stopTimer();
    timerSeconds = Number(seconds||0);
    if(timerSeconds <= 0) return;

    timerEndsAt = Date.now() + timerSeconds*1000;
    timerInterval = setInterval(()=>{
      const remaining = Math.ceil((timerEndsAt - Date.now())/1000);
      if(remaining <= 0){
        stopTimer();
        playBeep(3);
        toast('Rest timer done');
        render();
        return;
      }
      timerSeconds = remaining;
      updateTimerDisplay();
    }, 250);
    updateTimerDisplay();
  }

  function stopTimer(){
    if(timerInterval){
      clearInterval(timerInterval);
      timerInterval = null;
    }
    timerEndsAt = null;
    timerSeconds = 0;
    updateTimerDisplay();
  }

  function updateTimerDisplay(){
    const el = document.getElementById('timerDisplay');
    if(!el) return;
    if(timerSeconds > 0){
      el.textContent = formatTime(timerSeconds);
    }else{
      el.textContent = '‚Äî';
    }
  }

  // ---------------------------
  // UI helpers
  // ---------------------------
  function toast(msg){
    // lightweight toast: reuse browser alert? no. we‚Äôll do a transient pill.
    const existing = document.getElementById('toast');
    if(existing) existing.remove();

    const t = document.createElement('div');
    t.id = 'toast';
    t.textContent = msg;
    t.style.position = 'fixed';
    t.style.left = '50%';
    t.style.bottom = '100px';
    t.style.transform = 'translateX(-50%)';
    t.style.padding = '10px 12px';
    t.style.borderRadius = '999px';
    t.style.border = '1px solid var(--border)';
    t.style.background = 'rgba(0,0,0,0.55)';
    t.style.color = 'white';
    t.style.backdropFilter = 'blur(10px)';
    t.style.zIndex = '999';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity 250ms'; }, 1100);
    setTimeout(()=>{ t.remove(); }, 1500);
  }

  function downloadJSON(filename, data){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // ---------------------------
  // Set editing modal
  // ---------------------------
  const modalBackdrop = document.getElementById('editModalBackdrop');
  const editWeight = document.getElementById('editWeight');
  const editReps = document.getElementById('editReps');
  const editType = document.getElementById('editType');
  const editRest = document.getElementById('editRest');
  const editNote = document.getElementById('editNote');

  document.getElementById('editCancel').addEventListener('click', ()=>closeEditModal());
  modalBackdrop.addEventListener('click', (e)=>{
    if(e.target === modalBackdrop) closeEditModal();
  });

  document.getElementById('editSave').addEventListener('click', ()=>{
    if(!editContext) return;
    const w = getWorkoutForDate(editContext.date);
    const ex = w.exercises.find(x => x.name === editContext.exName);
    if(!ex) return;

    const set = ex.sets.find(s => s.id === editContext.setId);
    if(!set) return;

    set.weight = Number(editWeight.value || 0);
    set.reps = Number(editReps.value || 0);
    set.type = editType.value;
    set.rest = Number(editRest.value || 0);
    set.note = (editNote.value || '').trim();

    upsertWorkout(w);
    rebuildCaches();
    closeEditModal();
    render();
  });

  document.getElementById('editDelete').addEventListener('click', ()=>{
    if(!editContext) return;
    const w = getWorkoutForDate(editContext.date);
    const ex = w.exercises.find(x => x.name === editContext.exName);
    if(!ex) return;
    ex.sets = ex.sets.filter(s => s.id !== editContext.setId);
    upsertWorkout(w);
    rebuildCaches();
    closeEditModal();
    render();
  });

  function openEditModal(date, exName, setId){
    const w = getWorkoutForDate(date);
    const ex = w.exercises.find(x => x.name === exName);
    const s = ex?.sets?.find(x => x.id === setId);
    if(!s) return;

    editContext = {date, exName, setId};
    editWeight.value = (s.weight ?? '');
    editReps.value = (s.reps ?? '');
    editType.value = s.type || 'working';
    editRest.value = (s.rest ?? '');
    editNote.value = s.note || '';
    modalBackdrop.classList.add('open');

    setTimeout(()=> editWeight.focus(), 60);
  }

  function closeEditModal(){
    editContext = null;
    modalBackdrop.classList.remove('open');
  }

  // ---------------------------
  // Rendering
  // ---------------------------
  function render(){
    rebuildCaches();
    const app = document.getElementById('app');
    const day = dayFromDate(currentDate);
    const workout = getWorkoutForDate(currentDate);
    const isRest = !!restDates[currentDate];

    app.innerHTML = `
      <header>
        <h1>ZeroLog <span class="pill">${niceDate(currentDate)}</span></h1>
        <div class="top-actions">
          <button class="icon-btn" id="themeBtn" title="Toggle theme">${theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'}</button>
          <button class="icon-btn" id="menuBtn" title="Menu">‚ò∞</button>
        </div>
      </header>

      <div class="card">
        <div class="row space">
          <div>
            <div class="title">${day} ${isRest ? '‚Ä¢ Rest Day' : ''}</div>
            <div class="sub">Tap a set to edit. Drag handles to reorder exercises.</div>
          </div>
          <div class="stack">
            <button class="btn ${isRest ? 'ghost' : 'danger'}" id="restBtn">${isRest ? 'Unmark rest day' : 'Mark rest day (today)'}</button>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="workout">Workout</div>
          <div class="tab" data-tab="history">History</div>
          <div class="tab" data-tab="data">Data</div>
          <div class="tab" data-tab="settings">Settings</div>
        </div>
      </div>

      <div class="grid">
        <div class="card" id="tab_workout">
          <div class="row space">
            <div>
              <div class="title">Today‚Äôs workout</div>
              <div class="sub">${isRest ? 'Rest marked for this date. You can still log sets.' : 'Log fast. Timer auto-start optional.'}</div>
            </div>
            <div class="timer">
              <div>
                <div class="small muted">Rest timer</div>
                <div class="big" id="timerDisplay">‚Äî</div>
              </div>
              <div class="controls">
                <button class="btn ghost" id="timerStop">Stop</button>
              </div>
            </div>
          </div>

          <hr class="hr"/>

          <div id="workoutList" class="grid" style="grid-template-columns:1fr; gap:12px;"></div>

          <hr class="hr"/>

          <div class="title" style="margin-bottom:8px;">Notes (${niceDate(currentDate)})</div>
          <textarea class="textarea" id="notesBox" placeholder="Session notes‚Ä¶">${escapeHTML(notesByDate[currentDate] || '')}</textarea>
          <div class="row space" style="margin-top:10px;">
            <div class="sub">Saved per date (YYYY-MM-DD). No more missing notes.</div>
            <button class="btn primary" id="saveNotes">Save notes</button>
          </div>
        </div>

        <div class="card" id="tab_side">
          <div id="sidePanel"></div>
        </div>
      </div>
    `;

    // Wire top buttons
    document.getElementById('themeBtn').onclick = toggleTheme;
    document.getElementById('menuBtn').onclick = openMenu;
    document.getElementById('restBtn').onclick = toggleRestDate;
    document.getElementById('timerStop').onclick = () => { stopTimer(); render(); };

    document.getElementById('saveNotes').onclick = () => {
      const text = document.getElementById('notesBox').value || '';
      notesByDate[currentDate] = text.trim();
      saveJSON(LS.notes, notesByDate);
      toast('Notes saved');
    };

    // Dock nav
    document.getElementById('dockPrev').onclick = () => shiftDate(-1);
    document.getElementById('dockNext').onclick = () => shiftDate(1);
    document.getElementById('dockToday').onclick = () => { currentDate = todayISO(); render(); };

    updateTimerDisplay();

    // Build workout list
    const list = document.getElementById('workoutList');
    list.innerHTML = workout.exercises.length ? '' : `<div class="muted">No exercises for ${day}. Add from Menu ‚Üí Edit programme.</div>`;

    workout.exercises.forEach((ex, idx) => {
      const prText = getPRText(ex.name);
      const nextWeight = suggestNextWeight(ex.name, ex.defaults);
      const last = cacheLastByExercise.get(ex.name);

      const card = document.createElement('div');
      card.className = 'workout-ex';
      card.setAttribute('draggable','true');
      card.dataset.exId = ex.id;
      card.dataset.exName = ex.name;

      card.innerHTML = `
        <div class="head">
          <div style="min-width:0">
            <div class="ex-name">
              <span class="handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
              <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHTML(ex.name)}</span>
            </div>
            <div class="ex-meta">
              ${prText ? `<span class="chip ok">${escapeHTML(prText)}</span>` : `<span class="chip">PR: ‚Äî</span>`}
              ${last ? `<span class="chip">Last: ${niceDate(last.date)}</span>` : `<span class="chip">Last: ‚Äî</span>`}
              ${nextWeight ? `<span class="chip primary">Next: ${escapeHTML(nextWeight)}kg</span>` : ``}
            </div>
          </div>
          <div class="stack">
            <button class="btn ghost" data-action="defaults">Defaults</button>
          </div>
        </div>

        <div class="sets">
          <div class="set-row">
            <input type="number" step="0.5" inputmode="decimal" placeholder="Weight (kg)" value="${nextWeight ? escapeHTML(nextWeight) : ''}" data-field="w" />
            <input type="number" step="1" inputmode="numeric" placeholder="Reps" data-field="r" />
            <select data-field="t">
              <option value="working">üí™ Working</option>
              <option value="warmup">üü° Warm-up</option>
              <option value="cluster">üîó Cluster</option>
              <option value="drop">‚¨áÔ∏è Drop</option>
              <option value="amrap">‚ôæÔ∏è AMRAP</option>
            </select>
            <button class="btn primary" data-action="add">Add</button>
          </div>

          <div class="row space">
            <div class="sub">Rest default: <b>${Number(ex.defaults?.rest || 90)}s</b> ‚Ä¢ Step: <b>${Number(ex.defaults?.step || 2.5)}kg</b></div>
            <div class="stack">
              <button class="btn ghost" data-action="quick">+1 set</button>
            </div>
          </div>

          <div class="set-list" data-sets></div>
        </div>
      `;

      // render existing sets
      const setList = card.querySelector('[data-sets]');
      (ex.sets || []).forEach(s => {
        setList.appendChild(renderSetItem(currentDate, ex.name, s));
      });

      // actions
      card.querySelector('[data-action="add"]').onclick = () => {
        const wInput = card.querySelector('[data-field="w"]');
        const rInput = card.querySelector('[data-field="r"]');
        const tSel = card.querySelector('[data-field="t"]');
        const weight = Number(wInput.value || 0);
        const reps = Number(rInput.value || 0);
        const type = tSel.value;

        // inline validation + micro UX
        if(!weight || !reps){
          if(!weight) wInput.focus();
          else rInput.focus();
          toast('Weight + reps required');
          return;
        }

        const set = {
          id: uid(),
          weight, reps, type,
          rest: Number(ex.defaults?.rest || 90),
          note: ''
        };

        ex.sets = ex.sets || [];
        ex.sets.push(set);
        upsertWorkout(workout);
        rebuildCaches();

        // re-render this card sets only
        setList.appendChild(renderSetItem(currentDate, ex.name, set));

        // auto advance focus
        rInput.value = '';
        rInput.focus();

        // optional timer
        if(settings.autoStartTimer){
          startTimer(set.rest || 90);
        }
      };

      card.querySelector('[data-action="quick"]').onclick = () => {
        // add same as last set if exists, else no-op
        const lastSet = (ex.sets || []).slice(-1)[0];
        if(!lastSet){
          toast('No previous set to copy');
          return;
        }
        const copy = {...lastSet, id: uid()};
        ex.sets.push(copy);
        upsertWorkout(workout);
        rebuildCaches();
        setList.appendChild(renderSetItem(currentDate, ex.name, copy));
        if(settings.autoStartTimer){
          startTimer(copy.rest || 90);
        }
      };

      card.querySelector('[data-action="defaults"]').onclick = () => {
        const rest = prompt(`Default rest for ${ex.name} (seconds):`, String(ex.defaults?.rest ?? 90));
        if(rest === null) return;
        const step = prompt(`Increment step for ${ex.name} (kg):`, String(ex.defaults?.step ?? 2.5));
        if(step === null) return;

        ex.defaults = ex.defaults || {};
        ex.defaults.rest = clamp(Number(rest||90), 0, 9999);
        ex.defaults.step = clamp(Number(step||2.5), 0, 200);

        upsertWorkout(workout);
        // also persist into programme template for this day if matching by name
        const tpl = program[day] || [];
        const t = tpl.find(x => x.name === ex.name);
        if(t){
          t.defaults = t.defaults || {};
          t.defaults.rest = ex.defaults.rest;
          t.defaults.step = ex.defaults.step;
          saveJSON(LS.program, program);
        }
        render();
      };

      // drag reorder (only workout-ex cards)
      wireDragReorder(card, workout);

      list.appendChild(card);
    });

    // Side panel (lightweight summary + quick actions)
    document.getElementById('sidePanel').innerHTML = renderSidePanel(workout);

    // Tabs behaviour
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick = () => switchTab(tab.dataset.tab);
    });

    // Default view: workout + side panel
    switchTab('workout');

    // Ensure workout exists in history if user modifies
    upsertWorkout(workout);
  }

  function renderSidePanel(workout){
    const totalSets = (workout.exercises||[]).reduce((a,ex)=> a + (ex.sets?.length||0), 0);
    const prs = (workout.exercises||[]).filter(ex => !!cachePRByExercise.get(ex.name)).length;

    return `
      <div class="title">Summary</div>
      <div class="sub">Quick view for ${niceDate(workout.date)}.</div>
      <div class="tabs" style="margin-top:10px">
        <div class="pill">Exercises: <b>${(workout.exercises||[]).length}</b></div>
        <div class="pill">Sets logged: <b>${totalSets}</b></div>
        <div class="pill">PR tracked: <b>${prs}</b></div>
      </div>

      <hr class="hr"/>

      <div class="title">Quick actions</div>
      <div class="stack" style="margin-top:10px">
        <button class="btn ghost" onclick="window.__zerolog_export()">Export</button>
        <button class="btn ghost" onclick="window.__zerolog_import()">Import</button>
        <button class="btn danger" onclick="window.__zerolog_clearToday()">Clear today</button>
      </div>

      <hr class="hr"/>

      <div class="title">History peek</div>
      <div class="sub">Latest 5 sessions.</div>
      <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
        ${renderHistoryPeek(5)}
      </div>
    `;
  }

  function renderHistoryPeek(n){
    const sorted = [...history].sort((a,b)=> b.date.localeCompare(a.date)).slice(0,n);
    if(!sorted.length) return `<div class="muted">No history yet.</div>`;
    return sorted.map(h=>{
      const sets = (h.exercises||[]).reduce((a,ex)=> a + (ex.sets?.length||0), 0);
      return `
        <div class="card" style="padding:10px; box-shadow:none;">
          <div class="row space">
            <div>
              <div class="title">${niceDate(h.date)}</div>
              <div class="sub">${h.day} ‚Ä¢ ${sets} sets</div>
            </div>
            <button class="btn ghost" style="padding:8px 10px" onclick="window.__zerolog_goto('${h.date}')">Open</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function switchTab(name){
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab === name));

    const side = document.getElementById('tab_side');
    const workoutTab = document.getElementById('tab_workout');

    if(name === 'workout'){
      side.style.display = '';
      workoutTab.style.display = '';
      return;
    }

    // replace workout tab content for other tabs
    side.style.display = 'none';
    workoutTab.style.display = '';
    if(name === 'history') renderHistoryTab();
    if(name === 'data') renderDataTab();
    if(name === 'settings') renderSettingsTab();
  }

  function renderHistoryTab(){
    const container = document.getElementById('tab_workout');
    const sorted = [...history].sort((a,b)=> b.date.localeCompare(a.date));

    container.innerHTML = `
      <div class="row space">
        <div>
          <div class="title">History</div>
          <div class="sub">Tap Open to view that date.</div>
        </div>
      </div>
      <hr class="hr"/>
      <div style="display:flex; flex-direction:column; gap:10px;">
        ${sorted.map(h=>{
          const sets = (h.exercises||[]).reduce((a,ex)=> a + (ex.sets?.length||0), 0);
          return `
            <div class="card" style="padding:12px; box-shadow:none;">
              <div class="row space">
                <div>
                  <div class="title">${niceDate(h.date)}</div>
                  <div class="sub">${h.day} ‚Ä¢ ${(h.exercises||[]).length} exercises ‚Ä¢ ${sets} sets${restDates[h.date] ? ' ‚Ä¢ Rest' : ''}</div>
                </div>
                <div class="stack">
                  <button class="btn ghost" onclick="window.__zerolog_goto('${h.date}')">Open</button>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderDataTab(){
    const container = document.getElementById('tab_workout');
    container.innerHTML = `
      <div class="row space">
        <div>
          <div class="title">Data</div>
          <div class="sub">Export/import your local data. (No API keys stored client-side.)</div>
        </div>
      </div>
      <hr class="hr"/>
      <div class="stack">
        <button class="btn primary" onclick="window.__zerolog_export()">Export JSON</button>
        <button class="btn ghost" onclick="window.__zerolog_import()">Import JSON</button>
      </div>

      <hr class="hr"/>

      <div class="title">What‚Äôs inside export</div>
      <div class="sub">Programme, history, notes, rest dates, settings.</div>
    `;
  }

  function renderSettingsTab(){
    const container = document.getElementById('tab_workout');
    container.innerHTML = `
      <div class="row space">
        <div>
          <div class="title">Settings</div>
          <div class="sub">Small tweaks that make logging fast.</div>
        </div>
      </div>

      <hr class="hr"/>

      <div class="card" style="box-shadow:none;">
        <div class="row space">
          <div>
            <div class="title">Auto start rest timer</div>
            <div class="sub">Starts after adding a set.</div>
          </div>
          <button class="btn ${settings.autoStartTimer ? 'primary' : 'ghost'}" id="toggleAuto">${settings.autoStartTimer ? 'On' : 'Off'}</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none;">
        <div class="row space">
          <div>
            <div class="title">Beep</div>
            <div class="sub">Plays when timer ends.</div>
          </div>
          <button class="btn ${settings.beepEnabled ? 'primary' : 'ghost'}" id="toggleBeep">${settings.beepEnabled ? 'On' : 'Off'}</button>
        </div>
      </div>
    `;

    document.getElementById('toggleAuto').onclick = ()=>{
      settings.autoStartTimer = !settings.autoStartTimer;
      saveJSON(LS.settings, settings);
      render();
    };
    document.getElementById('toggleBeep').onclick = ()=>{
      settings.beepEnabled = !settings.beepEnabled;
      saveJSON(LS.settings, settings);
      render();
    };
  }

  function renderSetItem(date, exName, set){
    const el = document.createElement('div');
    el.className = 'set-item';
    el.dataset.setId = set.id;

    const badgeClass = set.type || 'working';
    const badgeText = ({
      working:'üí™ Working', warmup:'üü° Warm-up', cluster:'üîó Cluster', drop:'‚¨áÔ∏è Drop', amrap:'‚ôæÔ∏è AMRAP'
    })[badgeClass] || 'üí™ Working';

    el.innerHTML = `
      <div class="left">
        <div class="main">${escapeHTML(String(set.weight))}kg √ó ${escapeHTML(String(set.reps))}</div>
        <div class="note">${set.note ? escapeHTML(set.note) : `<span class="muted">Tap to add note</span>`}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="type-badge ${badgeClass}">${badgeText}</div>
        <div class="pill" title="Rest (sec)">${escapeHTML(String(set.rest || 0))}s</div>
      </div>

      <div class="swipe-actions">
        <button class="mini ghost" data-swipe="cancel">Cancel</button>
        <button class="mini" data-swipe="delete">Delete</button>
      </div>
    `;

    // Tap to edit
    el.addEventListener('click', (e)=>{
      // if delete buttons clicked, ignore
      if(e.target && e.target.dataset && e.target.dataset.swipe) return;
      openEditModal(date, exName, set.id);
    });

    // Swipe handling: only if horizontal dominates
    wireSwipe(el, date, exName, set.id);

    el.querySelector('[data-swipe="cancel"]').onclick = (e)=>{
      e.stopPropagation();
      el.classList.remove('reveal');
    };
    el.querySelector('[data-swipe="delete"]').onclick = (e)=>{
      e.stopPropagation();
      deleteSet(date, exName, set.id);
    };

    return el;
  }

  function deleteSet(date, exName, setId){
    const w = getWorkoutForDate(date);
    const ex = w.exercises.find(x => x.name === exName);
    if(!ex) return;
    ex.sets = (ex.sets||[]).filter(s => s.id !== setId);
    upsertWorkout(w);
    rebuildCaches();
    toast('Set deleted');
    render();
  }

  function wireSwipe(el, date, exName, setId){
    let sx=0, sy=0, dx=0, dy=0, tracking=false;

    el.addEventListener('touchstart', (e)=>{
      if(e.touches.length !== 1) return;
      const t = e.touches[0];
      sx = t.clientX; sy = t.clientY;
      dx = 0; dy = 0;
      tracking = true;
    }, {passive:true});

    el.addEventListener('touchmove', (e)=>{
      if(!tracking || e.touches.length !== 1) return;
      const t = e.touches[0];
      dx = t.clientX - sx;
      dy = t.clientY - sy;

      // only handle if mostly horizontal
      if(Math.abs(dx) > Math.abs(dy) + 8){
        // prevent scroll when horizontal swipe
        e.preventDefault();
      }
    }, {passive:false});

    el.addEventListener('touchend', ()=>{
      if(!tracking) return;
      tracking = false;

      // horizontal swipe threshold
      if(Math.abs(dx) > Math.abs(dy) + 8 && dx < -60){
        el.classList.add('reveal');
      }else{
        el.classList.remove('reveal');
      }
    });
  }

  function wireDragReorder(card, workout){
    const list = document.getElementById('workoutList');
    if(!list) return;

    card.addEventListener('dragstart', (e)=>{
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.dataset.exId);
    });

    card.addEventListener('dragend', ()=>{
      card.classList.remove('dragging');
      persistReorderFromDOM(workout);
    });

    list.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const dragging = list.querySelector('.workout-ex.dragging');
      if(!dragging) return;

      const after = getDragAfterElement(list, e.clientY);
      if(after == null){
        list.appendChild(dragging);
      }else{
        list.insertBefore(dragging, after);
      }
    }, {passive:false});
  }

  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.workout-ex:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset){
        return { offset, element: child };
      }
      return closest;
    }, {offset: Number.NEGATIVE_INFINITY, element: null}).element;
  }

  function persistReorderFromDOM(workout){
    const list = document.getElementById('workoutList');
    if(!list) return;
    const ids = [...list.querySelectorAll('.workout-ex')].map(el => el.dataset.exId);
    const newOrder = [];
    ids.forEach(id=>{
      const ex = workout.exercises.find(x => String(x.id) === String(id));
      if(ex) newOrder.push(ex);
    });
    // keep any missing at end
    workout.exercises.forEach(ex=>{
      if(!newOrder.includes(ex)) newOrder.push(ex);
    });
    workout.exercises = newOrder;
    upsertWorkout(workout);
  }

  function toggleTheme(){
    theme = (theme === 'dark') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(LS.theme, theme);
    render();
  }

  function openMenu(){
    const choice = prompt(
`Menu:
1) Edit programme (simple)
2) Export
3) Import
4) Clear all data

Enter 1/2/3/4:`
    );
    if(choice === '1') editProgramme();
    if(choice === '2') window.__zerolog_export();
    if(choice === '3') window.__zerolog_import();
    if(choice === '4') clearAll();
  }

  function editProgramme(){
    const day = dayFromDate(currentDate);
    const current = (program[day]||[]).map(x=>x.name).join(', ');
    const input = prompt(`Programme for ${day} (comma-separated exercise names):`, current);
    if(input === null) return;
    const names = input.split(',').map(s=>s.trim()).filter(Boolean);

    program[day] = names.map(name => {
      const existing = (program[day]||[]).find(x=>x.name === name);
      return {
        id: existing?.id || uid(),
        name,
        defaults: existing?.defaults || {rest:90, step:2.5}
      };
    });

    saveJSON(LS.program, program);

    // If current date uses this day, regenerate workout template if empty exercises
    const w = getWorkoutForDate(currentDate);
    if(!w.exercises || w.exercises.length === 0){
      w.exercises = (program[day]||[]).map(ex => ({
        id: ex.id,
        name: ex.name,
        defaults: ex.defaults || {rest:90, step:2.5},
        sets: []
      }));
      upsertWorkout(w);
    }
    render();
  }

  function toggleRestDate(){
    restDates[currentDate] = !restDates[currentDate];
    if(!restDates[currentDate]) delete restDates[currentDate];
    saveJSON(LS.rest, restDates);
    render();
  }

  function shiftDate(deltaDays){
    const d = new Date(currentDate + 'T00:00:00');
    d.setDate(d.getDate() + deltaDays);
    currentDate = d.toISOString().slice(0,10);
    render();
  }

  function clearAll(){
    const ok = confirm('Clear ALL data (programme, history, notes, rest, settings)?');
    if(!ok) return;
    localStorage.removeItem(LS.program);
    localStorage.removeItem(LS.history);
    localStorage.removeItem(LS.notes);
    localStorage.removeItem(LS.rest);
    localStorage.removeItem(LS.settings);
    program = defaultProgram;
    history = [];
    notesByDate = {};
    restDates = {};
    settings = defaultSettings;
    toast('Cleared');
    render();
  }

  // ---------------------------
  // Export / Import (validated)
  // ---------------------------
  window.__zerolog_export = () => {
    const payload = { program, history, notesByDate, restDates, settings, version: 2 };
    downloadJSON(`zerolog_export_${todayISO()}.json`, payload);
  };

  window.__zerolog_import = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);

        // Minimal shape validation
        if(typeof data !== 'object' || data === null) throw new Error('Invalid file');
        if(data.program && typeof data.program !== 'object') throw new Error('Invalid programme');
        if(data.history && !Array.isArray(data.history)) throw new Error('Invalid history');

        // Merge safely
        if(data.program) program = data.program;
        if(data.history) history = data.history;
        if(data.notesByDate && typeof data.notesByDate === 'object') notesByDate = data.notesByDate;
        if(data.restDates && typeof data.restDates === 'object') restDates = data.restDates;
        if(data.settings && typeof data.settings === 'object') settings = {...defaultSettings, ...data.settings};

        saveJSON(LS.program, program);
        saveJSON(LS.history, history);
        saveJSON(LS.notes, notesByDate);
        saveJSON(LS.rest, restDates);
        saveJSON(LS.settings, settings);

        toast('Import complete');
        render();
      }catch(e){
        alert('Import failed: ' + (e?.message || 'Unknown error'));
      }
    };
    input.click();
  };

  window.__zerolog_clearToday = () => {
    const ok = confirm(`Clear all sets for ${niceDate(currentDate)}?`);
    if(!ok) return;
    const w = getWorkoutForDate(currentDate);
    (w.exercises||[]).forEach(ex => ex.sets = []);
    upsertWorkout(w);
    rebuildCaches();
    toast('Cleared today');
    render();
  };

  window.__zerolog_goto = (iso) => {
    currentDate = iso;
    render();
  };

  // ---------------------------
  // Escape HTML
  // ---------------------------
  function escapeHTML(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // Boot
  render();
})();
</script>

</body>
</html>
